<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NITA GAMES</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- MODERN THEME --- */
        :root {
            --bg: #0f0c29;
            --gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --panel: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.15);
            --text: #ffffff;
            --accent: #00f260;
            --uno-red: #ff5e57;
            --uno-blue: #0fbcf9;
            --uno-green: #0be881;
            --uno-yellow: #ffdd59;
        }
        body { background: var(--gradient); color: var(--text); font-family: 'Outfit', sans-serif; margin: 0; height: 100vh; display: flex; overflow: hidden; }

        /* LAYOUT */
        #main-app { display: flex; width: 100%; height: 100%; padding: 25px; gap: 25px; box-sizing: border-box; }
        #game-view { flex: 3; border-radius: 24px; background: var(--panel); border: 1px solid var(--border); backdrop-filter: blur(20px); position: relative; overflow: hidden; display: flex; flex-direction: column; }
        #sidebar { flex: 1; min-width: 320px; border-radius: 24px; background: var(--panel); border: 1px solid var(--border); backdrop-filter: blur(20px); display: flex; flex-direction: column; overflow: hidden; }

        /* UI ELEMENTS */
        h1 { position: absolute; top: 25px; left: 35px; margin: 0; font-weight: 700; background: linear-gradient(to right, #00f260, #0575E6); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        button { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 12px 24px; border-radius: 12px; cursor: pointer; transition: 0.3s; font-family: inherit; font-weight: 600; }
        button:hover { background: white; color: #302b63; transform: translateY(-2px); }
        input, select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 14px; border-radius: 12px; outline: none; box-sizing: border-box; font-family: inherit; width: 100%; }

        /* MODAL */
        #login-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: flex; gap: 40px; align-items: center; justify-content: center; }
        .glass-card { background: rgba(255,255,255,0.05); padding: 40px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); width: 340px; }

        /* UNO TABLE */
        #uno-table { width: 100%; height: 100%; position: relative; display: none; }
        .opp-container { position: absolute; top: 0; left: 0; width: 100%; height: 50%; display: flex; justify-content: center; align-items: center; gap: 30px; }
        .opp-card { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 16px; border: 1px solid var(--border); text-align: center; min-width: 100px; }
        .opp-card.turn { border-color: var(--accent); box-shadow: 0 0 20px rgba(0,242,96,0.3); transform: scale(1.1); transition: 0.3s; }
        .uno-card { width: 90px; height: 135px; border-radius: 12px; border: 4px solid white; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: 800; color: white; position: relative; user-select: none; transition: 0.3s; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .uno-card:hover { transform: translateY(-20px); }
        .u-red { background: var(--uno-red); } .u-blue { background: var(--uno-blue); } .u-green { background: var(--uno-green); } .u-yellow { background: var(--uno-yellow); color:#444; } .u-black { background: #222; } .u-back { background: #222; background-image: radial-gradient(#444 15%, transparent 16%); background-size: 20px 20px; }
        .my-hand { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: -40px; }
        .current-bg { width: 300px; height: 300px; border-radius: 50%; position: absolute; top:50%; left:50%; transform:translate(-50%,-20%); z-index: 0; opacity: 0.2; filter: blur(60px); }

        #sys-msg { position: absolute; bottom: 120px; width: 100%; text-align: center; color: white; font-size: 1.5rem; font-weight: 700; z-index: 10; }
        #color-picker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 50; display: none; align-items: center; justify-content: center; gap: 30px; }
        .cp-btn { width: 100px; height: 100px; border-radius: 50%; border: 6px solid white; cursor: pointer; }

        /* CHAT */
        .tabs { display: flex; padding: 10px; }
        .tab { flex:1; text-align:center; padding:10px; cursor:pointer; color:#666; }
        .tab.active { color:#fff; font-weight:700; background:rgba(255,255,255,0.05); border-radius:10px; }
        .chat-content { flex:1; overflow-y:auto; padding:20px; font-size:0.9rem; }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="glass-card">
            <h2 style="text-align:center;">NITA GAMES</h2>
            <input type="text" id="username" placeholder="名前">
            <input type="text" id="room" placeholder="ルームID">
            <select id="gameType">
                <option value="uno">UNO (最大6人)</option>
                <option value="blackjack">BJ (PROTOCOL 21)</option>
                <option value="override">OV (Hi&Lo)</option>
            </select>
            <input type="number" id="buyin" value="1000">
            <button id="join-btn" onclick="joinGame()">アクセス開始</button>
        </div>
        <div class="glass-card" style="height: 400px; display:flex; flex-direction:column;">
            <div id="lobby-log" style="flex:1; overflow-y:auto; font-size:0.8rem;"></div>
            <input id="lobby-input" placeholder="LOBBY CHAT" onkeydown="if(event.key==='Enter')sendLobby()">
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <div id="game-view">
            <h1>NITA GAMES</h1>
            <div id="uno-table">
                <div id="uno-bg" class="current-bg u-black"></div>
                <div class="opp-container" id="uno-opponents"></div>
                <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-20%); display:flex; gap:30px;">
                    <div class="uno-card u-back" onclick="socket.emit('unoDraw', {room:roomID})">UNO</div>
                    <div id="uno-pile"></div>
                </div>
                <div class="my-hand" id="uno-hand"></div>
                <div id="color-picker">
                    <div class="cp-btn u-red" onclick="pickColor('red')"></div>
                    <div class="cp-btn u-blue" onclick="pickColor('blue')"></div>
                    <div class="cp-btn u-green" onclick="pickColor('green')"></div>
                    <div class="cp-btn u-yellow" onclick="pickColor('yellow')"></div>
                </div>
            </div>
            <div id="sys-msg"></div>
        </div>

        <div id="sidebar">
            <div style="padding:20px; border-bottom:1px solid var(--border);">
                <div style="font-size:0.8rem; color:#aaa;">WALLET</div>
                <div style="font-size:1.8rem; font-weight:700;" id="wealth">---</div>
            </div>
            <div class="tabs">
                <div class="tab active" onclick="tab('global')" id="t-global">GLOBAL</div>
                <div class="tab" onclick="tab('room')" id="t-room">ROOM</div>
            </div>
            <div id="c-global" class="chat-content"></div>
            <div id="c-room" class="chat-content" style="display:none;"></div>
            <input id="chat-in" placeholder="メッセージ..." onkeydown="if(event.key==='Enter')sendChat()">
        </div>
    </div>

    <script>
        const socket = io();
        let roomID='', myUser='', myTurn=false, pendingI=-1;
        const $ = id => document.getElementById(id);

        function joinGame() {
            myUser=$('username').value; roomID=$('room').value;
            socket.emit('joinRoom', {username:myUser, room:roomID, gameType:$('gameType').value, buyInAmount:$('buyin').value});
        }
        socket.on('joined', d => { $('login-modal').style.display='none'; $('main-app').style.display='flex'; $('wealth').innerText=d.wealth; tab('room'); });
        socket.on('roomUpdate', d => { if(d.gameType==='uno'){ $('uno-table').style.display='block'; renderUnoLobby(d.players); } });

        function renderUnoLobby(ps) {
            const m = ps.find(p=>p.username===myUser); if(!m)return;
            $('sys-msg').innerHTML = !m.ready ? `<button onclick="socket.emit('toggleReady',{room:roomID})">準備完了</button>` : "他プレイヤーを待機中...";
        }

        socket.on('unoUpdate', d => {
            myTurn = d.isMyTurn;
            $('uno-opponents').innerHTML = d.players.filter(p=>p.username!==myUser).map(p=>`<div class="opp-card ${p.isTurn?'turn':''}">${p.username}<br>${p.handCount}枚</div>`).join('');
            $('uno-pile').innerHTML = `<div class="uno-card u-${d.currentColor}">${d.topCard.type.toUpperCase()}</div>`;
            $('uno-bg').className = `current-bg u-${d.currentColor}`;
            $('uno-hand').innerHTML = d.myHand.map((c,i)=>`<div class="uno-card ${c.color==='black'?'u-black':`u-${c.color}`}" onclick="tryPlay(${i},'${c.type}')">${c.type.toUpperCase()}</div>`).join('');
            $('sys-msg').innerText = myTurn ? "YOUR TURN" : "";
        });

        function tryPlay(i, t) {
            if(!myTurn) return;
            if(t==='wild'||t==='draw4'){ pendingI=i; $('color-picker').style.display='flex'; }
            else socket.emit('unoMove', {room:roomID, cardIndex:i});
        }
        function pickColor(c) { $('color-picker').style.display='none'; socket.emit('unoMove', {room:roomID, cardIndex:pendingI, colorChoice:c}); }

        // CHAT
        function sendLobby() { socket.emit('sendChat',{type:'global', username:$('username').value, text:$('lobby-input').value}); $('lobby-input').value=''; }
        function sendChat() { socket.emit('sendChat',{type:'room', room:roomID, username:myUser, text:$('chat-in').value}); $('chat-in').value=''; }
        socket.on('chatMsg', m => { 
            const h = `<div><strong>${m.username}</strong>: ${m.text}</div>`;
            if(m.type==='global'){ $('lobby-log').innerHTML+=h; $('c-global').innerHTML+=h; } else $('c-room').innerHTML+=h;
        });
        function tab(m) { $('c-global').style.display=m==='global'?'block':'none'; $('c-room').style.display=m==='room'?'block':'none'; }
        socket.on('gameOver', d => { alert(d.msg); location.reload(); });
        socket.on('error', m => alert(m));
    </script>
</body>
</html>