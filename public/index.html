<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NITA GAMES</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- MODERN GLASSPUNK THEME --- */
        :root {
            --bg: #0f0c29;
            --gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --panel: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.15);
            --text: #ffffff;
            --accent: #00f260;
            --accent-sec: #0575E6;
            --uno-red: #ff5e57;
            --uno-blue: #0fbcf9;
            --uno-green: #0be881;
            --uno-yellow: #ffdd59;
        }
        
        body {
            background: var(--gradient);
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            margin: 0; height: 100vh; display: flex; overflow: hidden;
        }

        /* --- LAYOUT --- */
        #main-app { display: flex; width: 100%; height: 100%; padding: 25px; gap: 25px; box-sizing: border-box; }
        
        #game-view { 
            flex: 3; border-radius: 24px; 
            background: var(--panel); border: 1px solid var(--border);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            position: relative; overflow: hidden; display: flex; flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        
        #sidebar { 
            flex: 1; min-width: 320px; border-radius: 24px; 
            background: var(--panel); border: 1px solid var(--border);
            backdrop-filter: blur(20px); display: flex; flex-direction: column;
            overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        /* --- COMPONENTS --- */
        h1 { position: absolute; top: 25px; left: 35px; margin: 0; font-weight: 700; letter-spacing: 2px; background: linear-gradient(to right, #00f260, #0575E6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        button {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 12px 24px; border-radius: 12px;
            font-weight: 600; cursor: pointer; transition: 0.3s;
            font-family: inherit;
        }
        button:hover { background: white; color: #302b63; transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        
        input, select {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 14px; border-radius: 12px; outline: none; width: 100%; 
            box-sizing: border-box; font-family: inherit; transition: 0.3s;
        }
        input:focus { border-color: var(--accent); background: rgba(0,0,0,0.5); }

        /* --- LOGIN --- */
        #login-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 100;
            display: flex; gap: 40px; align-items: center; justify-content: center;
        }
        .glass-card {
            background: rgba(255,255,255,0.05); padding: 40px; border-radius: 30px;
            width: 340px; display: flex; flex-direction: column; gap: 15px;
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        /* --- CHAT --- */
        .tabs { display: flex; padding: 10px 10px 0; gap: 10px; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: rgba(255,255,255,0.5); transition: 0.3s; border-radius: 12px 12px 0 0; }
        .tab.active { color: white; background: rgba(255,255,255,0.05); font-weight: 600; }
        
        .chat-content { flex: 1; overflow-y: auto; padding: 20px; background: rgba(0,0,0,0.2); }
        .msg { margin-bottom: 12px; font-size: 0.9rem; line-height: 1.5; }
        .msg strong { margin-right: 8px; }
        
        .input-area { padding: 20px; display: flex; gap: 10px; border-top: 1px solid var(--border); }

        /* --- UNO TABLE --- */
        #uno-table { width: 100%; height: 100%; position: relative; display: none; }
        
        .opp-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            display: flex; justify-content: center; align-items: center; gap: 30px;
            padding-top: 20px;
        }
        .opp-card {
            background: rgba(0,0,0,0.4); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);
            text-align: center; width: 100px; transition: 0.3s;
        }
        .opp-card.turn { border-color: var(--accent); transform: scale(1.1); box-shadow: 0 0 20px rgba(0,242,96,0.3); }
        .opp-card.cpu { border-style: dashed; }

        .center-area {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -20%);
            display: flex; gap: 40px; align-items: center; z-index: 5;
        }
        .uno-card {
            width: 90px; height: 135px; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            font-size: 2.5rem; font-weight: 800; color: white;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); border: 4px solid white;
            position: relative; user-select: none; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .uno-card:hover { transform: translateY(-20px) scale(1.1); z-index: 100; cursor: pointer; }
        
        /* Colors */
        .u-red { background: var(--uno-red); }
        .u-blue { background: var(--uno-blue); }
        .u-green { background: var(--uno-green); }
        .u-yellow { background: var(--uno-yellow); color: #444; text-shadow: none; }
        .u-black { background: #2d3436; }
        .u-back { background: #2d3436; background-image: radial-gradient(#444 15%, transparent 16%); background-size: 20px 20px; }

        .current-bg {
            width: 300px; height: 300px; border-radius: 50%; position: absolute; top:50%; left:50%; transform:translate(-50%,-20%);
            z-index: 0; opacity: 0.2; filter: blur(60px); transition: 1s;
        }

        .my-hand {
            position: absolute; bottom: 30px; width: 100%;
            display: flex; justify-content: center; gap: -40px; /* Overlap */
            padding-bottom: 20px;
        }
        .my-hand:hover .uno-card { margin-right: 10px; } /* Spread on hover */

        #color-picker {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 50; display: none;
            align-items: center; justify-content: center; gap: 30px; backdrop-filter: blur(5px);
        }
        .cp-btn { width: 100px; height: 100px; border-radius: 50%; cursor: pointer; border: 6px solid white; transition:0.2s; }
        .cp-btn:hover { transform: scale(1.1); }

        /* --- BJ UI --- */
        #bj-table { width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .bj-cards { display: flex; gap: 10px; min-height: 100px; margin: 10px 0; justify-content: center; }
        .bj-card {
            width: 70px; height: 100px; background: white; color: black; border-radius: 8px;
            display: flex; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .bj-card.red { color: #e74c3c; }
        
        #bet-overlay {
            position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 20;
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-modal">
        <div class="glass-card">
            <h2 style="text-align:center; margin:0;">NITA GAMES</h2>
            <input type="text" id="username" placeholder="Nickname">
            <input type="text" id="room" placeholder="Room ID (e.g. 101)">
            <select id="gameType">
                <option value="uno">UNO (Max 6)</option>
                <option value="blackjack">Protocol 21 (BJ)</option>
                <option value="override">Override (Hi&Lo)</option>
            </select>
            <input type="number" id="buyin" value="1000" placeholder="Buy-In Credits">
            <button onclick="joinGame()" style="background: linear-gradient(90deg, #00f260, #0575E6); border:none;">ENTER SYSTEM</button>
        </div>
        
        <!-- Lobby Chat -->
        <div class="glass-card" style="height: 450px;">
            <div style="text-align:center; color:#aaa; font-size:0.8rem; letter-spacing:1px;">GLOBAL LOBBY</div>
            <div id="lobby-log" style="flex:1; background:rgba(0,0,0,0.2); border-radius:12px; overflow-y:auto; padding:15px; color:#ddd; font-size:0.85rem;"></div>
            <div style="display:flex; gap:10px;">
                <input id="lobby-input" placeholder="Say hello..." style="padding:10px;">
                <button onclick="sendLobby()" style="width:60px; padding:0;">➤</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" style="display:none;">
        <div id="game-view">
            <h1>NITA GAMES</h1>
            
            <!-- UNO UI -->
            <div id="uno-table">
                <div id="uno-bg" class="current-bg u-black"></div>
                
                <div class="opp-container" id="uno-opponents"></div>
                
                <div class="center-area">
                    <div style="text-align:center;">
                        <div class="uno-card u-back" onclick="socket.emit('unoDraw', {room:roomID})">UNO</div>
                        <div style="margin-top:5px; font-size:0.8rem; color:#aaa;">DRAW</div>
                    </div>
                    <div id="uno-pile"></div>
                </div>

                <div class="my-hand" id="uno-hand"></div>
                
                <div id="color-picker">
                    <div class="cp-btn u-red" onclick="pickColor('red')"></div>
                    <div class="cp-btn u-blue" onclick="pickColor('blue')"></div>
                    <div class="cp-btn u-green" onclick="pickColor('green')"></div>
                    <div class="cp-btn u-yellow" onclick="pickColor('yellow')"></div>
                </div>
            </div>

            <!-- BJ / OVERRIDE UI -->
            <div id="bj-table">
                <div id="bj-round" style="color:#aaa;">ROUND -/-</div>
                <div style="margin-bottom:10px; font-weight:bold;">DEALER</div>
                <div class="bj-cards" id="d-hand"></div>
                
                <div id="bj-seats" style="display:flex; gap:20px; margin-top:50px; flex-wrap:wrap; justify-content:center;"></div>

                <div id="bet-overlay">
                    <h2 style="color:white;">PLACE BET</h2>
                    <input type="range" id="bet-slider" min="10" max="1000" step="10" style="width:300px;" oninput="updateBet(this.value)">
                    <div style="font-size:3rem; font-weight:bold; color:white; margin:20px;" id="bet-val">10</div>
                    <button onclick="placeBet()" style="font-size:1.2rem;">CONFIRM BET</button>
                </div>
            </div>

            <div id="sys-msg" style="position:absolute; bottom:120px; width:100%; text-align:center; color:white; pointer-events:none; font-size:1.5rem; text-shadow:0 2px 10px rgba(0,0,0,0.5);"></div>
        </div>

        <!-- SIDEBAR -->
        <div id="sidebar">
            <div style="padding:20px; border-bottom:1px solid var(--border);">
                <div style="font-size:0.8rem; color:#aaa; letter-spacing:1px;">CREDITS</div>
                <div style="font-size:2rem; font-weight:700;" id="my-wealth">---</div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="tab('global')" id="t-global">GLOBAL</div>
                <div class="tab" onclick="tab('room')" id="t-room">ROOM</div>
            </div>
            <div class="chat-content">
                <div id="c-global" style="display:block;"></div>
                <div id="c-room" style="display:none;"></div>
            </div>
            <div class="input-area">
                <input id="chat-in" placeholder="Type message..." onkeydown="if(event.key==='Enter')sendChat()">
                <button onclick="sendChat()" style="padding:10px 20px;">➤</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let roomID='', myUser='', myColor='', activeTab='global';
        let pendingCardIndex = -1;

        const $ = id => document.getElementById(id);
        
        // --- CHAT ---
        function sendLobby() { 
            const t = $('lobby-input').value; 
            if(t) { socket.emit('sendChat', {type:'global', username:$('username').value, text:t}); $('lobby-input').value=''; }
        }
        function sendChat() {
            const t = $('chat-in').value;
            if(t) { socket.emit('sendChat', {type:activeTab, room:roomID, username:myUser, text:t, color:myColor}); $('chat-in').value=''; }
        }
        function tab(mode) {
            activeTab = mode;
            $('t-global').className = mode==='global'?'tab active':'tab';
            $('t-room').className = mode==='room'?'tab active':'tab';
            $('c-global').style.display = mode==='global'?'block':'none';
            $('c-room').style.display = mode==='room'?'block':'none';
        }
        socket.on('chatMsg', m => {
            const h = `<div class="msg"><strong style="color:${m.color||'#aaa'}">${m.username}</strong> ${m.text}</div>`;
            if(m.type==='global') { $('lobby-log').innerHTML+=h; $('c-global').innerHTML+=h; }
            if(m.type==='room') $('c-room').innerHTML+=h;
            $('lobby-log').scrollTop=$('lobby-log').scrollHeight;
            $('c-global').scrollTop=$('c-global').scrollHeight;
            $('c-room').scrollTop=$('c-room').scrollHeight;
        });

        // --- JOIN ---
        function joinGame() {
            myUser = $('username').value || 'GUEST';
            roomID = $('room').value;
            if(!roomID) return alert("Room ID required");
            socket.emit('joinRoom', { username:myUser, room:roomID, gameType:$('gameType').value, buyInAmount:$('buyin').value });
        }
        socket.on('joined', d => {
            myColor = d.color;
            $('login-modal').style.display='none';
            $('main-app').style.display='flex';
            $('my-wealth').innerText = d.wealth;
            tab('room');
        });
        socket.on('error', m => alert(m));

        // --- ROUTING ---
        socket.on('roomUpdate', d => {
            if(d.gameType==='uno') {
                $('uno-table').style.display='block'; $('bj-table').style.display='none';
                renderUnoLobby(d.players);
            } else {
                $('uno-table').style.display='none'; $('bj-table').style.display='flex';
                renderBjLobby(d.players);
            }
        });

        // --- UNO UI ---
        function renderUnoLobby(players) {
            const my = players.find(p=>p.username===myUser);
            if(!my) return;
            if(!my.ready && (!my.unoHand || my.unoHand.length===0)) {
                $('sys-msg').innerHTML = `<button onclick="socket.emit('toggleReady',{room:roomID})" style="font-size:1.5rem; padding:15px 40px; background:var(--accent);">READY TO START?</button>`;
            } else {
                $('sys-msg').innerHTML = "WAITING FOR OTHERS...";
            }
        }

        socket.on('unoUpdate', d => {
            // Update Opponents
            const ops = d.players.filter(p => p.username !== myUser);
            $('uno-opponents').innerHTML = ops.map(p => `
                <div class="opp-card ${p.isTurn?'turn':''} ${p.isCpu?'cpu':''}">
                    <div style="font-weight:bold; color:${p.color}">${p.username}</div>
                    <div style="font-size:2rem; font-weight:bold;">${p.handCount}</div>
                    <div style="font-size:0.7rem; color:#aaa;">CARDS</div>
                </div>
            `).join('');

            // Pile
            const top = d.topCard;
            let typeDisp = top.type;
            if(typeDisp==='draw2') typeDisp='+2'; if(typeDisp==='draw4') typeDisp='+4';
            if(typeDisp==='wild') typeDisp='W'; if(typeDisp==='skip') typeDisp='⊘'; if(typeDisp==='reverse') typeDisp='⇄';
            
            const colorClass = `u-${d.currentColor}`;
            $('uno-pile').innerHTML = `<div class="uno-card ${colorClass}">${typeDisp.toUpperCase()}</div>`;
            $('uno-bg').className = `current-bg ${colorClass}`;

            // My Hand
            $('uno-hand').innerHTML = d.myHand.map((c, i) => {
                let disp = c.type;
                if(disp==='draw2') disp='+2'; if(disp==='draw4') disp='+4'; if(disp==='wild') disp='W';
                if(disp==='skip') disp='⊘'; if(disp==='reverse') disp='⇄';
                const cc = (c.color==='black') ? 'u-black' : `u-${c.color}`;
                return `<div class="uno-card ${cc}" onclick="tryPlayUno(${i}, '${c.type}')" style="font-size:${disp.length>1?'1.5rem':'2.5rem'}">${disp.toUpperCase()}</div>`;
            }).join('');

            if(d.isMyTurn) $('sys-msg').innerText = "YOUR TURN";
            else $('sys-msg').innerText = "";
        });

        function tryPlayUno(idx, type) {
            if(type === 'wild' || type === 'draw4') {
                pendingCardIndex = idx;
                $('color-picker').style.display = 'flex';
            } else {
                socket.emit('unoMove', { room:roomID, cardIndex:idx, colorChoice:null });
            }
        }
        function pickColor(c) {
            $('color-picker').style.display = 'none';
            socket.emit('unoMove', { room:roomID, cardIndex:pendingCardIndex, colorChoice:c });
        }

        // --- BJ UI ---
        function renderBjLobby(players) {
            $('bj-seats').innerHTML = players.map((p,i) => `
                <div style="text-align:center; padding:15px; background:rgba(0,0,0,0.3); border-radius:16px; min-width:120px; border:1px solid rgba(255,255,255,0.1);">
                    <div style="color:${p.color}; font-weight:bold; margin-bottom:5px;">${p.username}</div>
                    <div style="font-size:1.2rem;">${p.score}</div>
                    <div id="h-${i}" class="bj-cards" style="transform:scale(0.7); margin-top:-10px;"></div>
                    ${p.username===myUser && !p.ready && p.hand.length===0 ? `<button onclick="socket.emit('toggleReady',{room:roomID})" style="margin-top:10px;">READY</button>` : ''}
                    <div id="act-${i}" style="margin-top:10px;"></div>
                </div>
            `).join('');
        }

        function updateBet(v) { $('bet-val').innerText = v; }
        function placeBet() { socket.emit('placeBet', {room:roomID, amount:$('bet-slider').value}); $('bet-overlay').style.display='none'; }

        socket.on('bjRoundStart', d => { $('bet-overlay').style.display='flex'; $('d-hand').innerHTML=''; });
        socket.on('ovRoundStart', d => { $('bet-overlay').style.display='flex'; $('d-hand').innerHTML=''; });

        socket.on('bjUpdate', d => updateCardGame(d, 'bj'));
        socket.on('ovUpdate', d => updateCardGame(d, 'ov'));

        function updateCardGame(d, type) {
            $('bet-overlay').style.display='none';
            const dc = d.dealerHand || (d.dealerCard ? [d.dealerCard] : []);
            $('d-hand').innerHTML = dc.map(c => mkCard(c)).join('');
            
            d.players.forEach((p,i) => {
                const div = $(`h-${i}`); 
                if(div) div.innerHTML = p.hand.map(c => mkCard(c)).join('');
                
                const act = $(`act-${i}`);
                if(act && p.username===myUser && i===d.turnIndex && d.phase==='playing') {
                    if(type==='bj') act.innerHTML = `<button onclick="socket.emit('bjAction',{room:roomID,action:'hit'})">HIT</button> <button onclick="socket.emit('bjAction',{room:roomID,action:'stand'})">STAND</button>`;
                    if(type==='ov') act.innerHTML = `<button onclick="socket.emit('ovAction',{room:roomID,choice:'high'})">HIGH</button> <button onclick="socket.emit('ovAction',{room:roomID,choice:'low'})">LOW</button>`;
                } else if(act) act.innerHTML = "";
            });
        }

        function mkCard(c) {
            if(!c.val && !c.power) return ``;
            const color = ['♥','♦'].includes(c.suit) ? 'red' : 'black';
            return `<div class="bj-card ${color}">${c.rank}<br><span style="font-size:2rem">${c.suit}</span></div>`;
        }

        socket.on('gameOver', d => { alert(d.msg); location.reload(); });

    </script>
</body>
</html>