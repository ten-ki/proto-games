<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NITA GAMES</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #121212;
            --panel: rgba(30, 30, 30, 0.6);
            --text: #ffffff;
            --accent: #00E676;
            --uno-red: #FF5252; --uno-blue: #448AFF; --uno-green: #69F0AE; --uno-yellow: #FFD740;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background: radial-gradient(circle at center, #1a1a2e, #000);
            color: var(--text); font-family: 'Outfit', sans-serif;
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- LAYOUT --- */
        #main-app { display: flex; width: 100%; height: 100%; padding: 10px; gap: 10px; }
        
        /* Game View (Left/Top) */
        #game-view { 
            flex: 1; border-radius: 16px; background: var(--panel); 
            position: relative; overflow: hidden; 
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column;
        }

        /* Sidebar (Right/Bottom) */
        #sidebar { 
            width: 300px; border-radius: 16px; background: var(--panel);
            border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column;
            /* Mobile adjustments done in media query */
        }

        /* --- UNO UI --- */
        #uno-table { width: 100%; height: 100%; position: relative; display: none; }

        /* Opponents (Top Arch) */
        .opp-container {
            position: absolute; top: 10px; width: 100%; height: 120px;
            display: flex; justify-content: center; gap: 10px; z-index: 10;
        }
        .opp-card {
            background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2); text-align: center;
            min-width: 70px; display: flex; flex-direction: column; justify-content: center;
            transition: 0.3s;
        }
        .opp-card.turn { border-color: var(--accent); box-shadow: 0 0 15px var(--accent); background: rgba(0, 230, 118, 0.1); transform: scale(1.05); }
        .opp-name { font-size: 0.7rem; color: #aaa; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80px; }
        .opp-count { font-size: 1.5rem; font-weight: 800; color: #fff; }

        /* Center Pile (Draw & Play) */
        .center-area {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            display: flex; gap: 20px; align-items: center; z-index: 5;
        }
        /* Current Color Ring */
        .color-ring {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 220px; height: 160px; border-radius: 20px;
            border: 4px solid transparent; pointer-events: none; transition: 0.5s;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .ring-red { border-color: var(--uno-red); box-shadow: 0 0 30px var(--uno-red), inset 0 0 20px var(--uno-red); }
        .ring-blue { border-color: var(--uno-blue); box-shadow: 0 0 30px var(--uno-blue), inset 0 0 20px var(--uno-blue); }
        .ring-green { border-color: var(--uno-green); box-shadow: 0 0 30px var(--uno-green), inset 0 0 20px var(--uno-green); }
        .ring-yellow { border-color: var(--uno-yellow); box-shadow: 0 0 30px var(--uno-yellow), inset 0 0 20px var(--uno-yellow); }

        /* Cards */
        .uno-card {
            width: 80px; height: 120px; border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            font-weight: 900; color: white; border: 3px solid white;
            position: relative; user-select: none; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            background: #333; transition: transform 0.2s;
        }
        /* Card Content Sizing */
        .uno-card span { font-size: 2.5rem; }
        .uno-card.long-text span { font-size: 1.5rem; } /* Reduce font for wild/draw4 */
        
        .uno-card:active { transform: scale(0.95); } /* Touch Feedback */

        .uno-card.disabled { opacity: 0.45; filter: grayscale(0.35); cursor: not-allowed; transform:none; }
        
        .u-red { background: var(--uno-red); }
        .u-blue { background: var(--uno-blue); }
        .u-green { background: var(--uno-green); }
        .u-yellow { background: var(--uno-yellow); color: #333; text-shadow: none; border-color: #333; }
        .u-black { background: #111; border-color: #888; }
        .u-back { 
            background: linear-gradient(45deg, #111 25%, #222 25%, #222 50%, #111 50%, #111 75%, #222 75%, #222);
            background-size: 20px 20px; border: 3px solid #666;
        }

        /* My Hand */
        .my-hand {
            position: absolute; bottom: 20px; width: 100%; height: 140px;
            display: flex; justify-content: center; align-items: flex-end;
            padding: 0 20px; overflow-x: auto; overflow-y: hidden;
            z-index: 100; /* ★重要: 最前面に配置 */
        }
        .hand-card-wrapper {
            margin-left: -35px; transition: 0.2s;
            flex-shrink: 0; width: 80px; height: 120px;
        }
        .hand-card-wrapper:first-child { margin-left: 0; }
        .hand-card-wrapper:hover, .hand-card-wrapper:active {
            transform: translateY(-20px); margin-right: 35px; z-index: 101;
        }
        .select-badge {
            position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.6);
            color: #fff; width: 22px; height: 22px; font-size: 0.8rem; display:flex; align-items:center; justify-content:center;
            border-radius: 50%; border: 2px solid rgba(255,255,255,0.6);
            pointer-events: none;
        }
        .select-badge.pop { animation: pop 260ms cubic-bezier(.2,.9,.2,1); }
        @keyframes pop { 0%{ transform: scale(0.6); opacity:0 } 60%{ transform: scale(1.15); opacity:1 } 100%{ transform: scale(1); } }

        .uno-card.selected { transform: translateY(-22px) scale(1.04); box-shadow: 0 10px 30px rgba(0,0,0,0.6); border-color: #fff; transition: transform 220ms ease, box-shadow 220ms ease; }

        .opp-card.turn { animation: pulse 1200ms infinite; }
        @keyframes pulse { 0%{ box-shadow: 0 0 8px rgba(0,230,118,0.14); transform: translateY(0) } 50%{ box-shadow: 0 0 18px rgba(0,230,118,0.22); transform: translateY(-4px) } 100%{ box-shadow: 0 0 8px rgba(0,230,118,0.14); transform: translateY(0) } }

        #uno-pile .uno-card { transition: transform 300ms ease, opacity 300ms ease; }
        #uno-pile.pop { animation: pilepop 320ms ease; }
        @keyframes pilepop { 0%{ transform: rotate(-8deg) scale(0.9); opacity:0 } 70%{ transform: rotate(2deg) scale(1.02); opacity:1 } 100%{ transform: rotate(0deg) scale(1); } }

        #sys-msg button { transition: transform 120ms ease, box-shadow 120ms ease; }
        #sys-msg button:active { transform: translateY(2px) scale(0.98); box-shadow: 0 6px 18px rgba(0,0,0,0.6); }

        /* Error Animation (Shake) */
        @keyframes shake {
            0% { transform: translateX(0); } 25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); }
        }
        .invalid-move { animation: shake 0.3s; border-color: red !important; }

        /* Color Picker Overlay */
        #color-picker {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); z-index: 200; display: none;
            align-items: center; justify-content: center; gap: 20px;
        }
        .cp-btn { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #fff; cursor: pointer; }

        /* --- BJ UI --- */
        #bj-table { width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .bj-cards { display: flex; gap: 5px; height: 90px; justify-content: center; margin-top: 5px; }
        .bj-card { width: 60px; height: 90px; background: white; color: black; border-radius: 6px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; font-weight: bold; border: 1px solid #ccc; }
        .bj-card.red { color: #e74c3c; }
        #bj-seats { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; width: 100%; padding: 10px; overflow-y: auto; }
        
        /* --- CHAT --- */
        .chat-content { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.85rem; background: rgba(0,0,0,0.3); }
        .input-area { display: flex; padding: 10px; gap: 5px; border-top: 1px solid rgba(255,255,255,0.1); }
        input { background: #222; border: none; color: white; padding: 10px; flex: 1; border-radius: 6px; }
        button.tx { background: var(--accent); color: black; border: none; padding: 0 15px; border-radius: 6px; font-weight: bold; }

        /* --- LOGIN MODAL --- */
        #login-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
        }
        .login-box {
            background: #222; padding: 30px; border-radius: 20px; width: 300px;
            display: flex; flex-direction: column; gap: 10px; border: 1px solid #444;
        }
        .login-box button { background: linear-gradient(90deg, #00C9FF, #92FE9D); border: none; padding: 15px; font-weight: bold; border-radius: 8px; margin-top: 10px; cursor: pointer; color: #000; }

        /* SYSTEM MSG */
        #sys-msg { 
            position: absolute; bottom: 160px; width: 100%; text-align: center; 
            pointer-events: none; z-index: 50; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); font-size: 1.2rem; font-weight: bold;
        }
        /* Make button inside sys-msg clickable */
        #sys-msg button { pointer-events: auto; padding: 10px 30px; font-size: 1.2rem; background: var(--accent); border: none; border-radius: 50px; box-shadow: 0 0 20px var(--accent); cursor: pointer; color: #000; font-weight: 800; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #main-app { flex-direction: column; padding: 0; gap: 0; }
            #game-view { flex: 2; border-radius: 0; border: none; border-bottom: 1px solid #333; }
            #sidebar { flex: 1; border-radius: 0; min-width: auto; }
            .my-hand { bottom: 10px; padding: 0 10px; }
            .hand-card-wrapper { width: 60px; height: 90px; margin-left: -25px; }
            .uno-card { width: 60px; height: 90px; font-size: 1.5rem; border-width: 2px; }
            .uno-card span { font-size: 1.5rem; }
            .center-area { transform: translate(-50%, -50%); } 
            .color-ring { width: 160px; height: 120px; }
        }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h2 style="text-align:center; color:white; margin:0;">NITA GAMES</h2>
            <input id="username" placeholder="NAME">
            <input id="room" placeholder="ROOM ID">
            <select id="gameType" style="padding:10px; background:#333; color:#fff; border:none; border-radius:6px;">
                <option value="uno">UNO (Max 6)</option>
                <option value="blackjack">BJ (Protocol 21)</option>
                <option value="override">OV (Hi&Lo)</option>
            </select>
            <input type="number" id="buyin" value="1000">
            <div style="display:flex; gap:8px;">
                <button onclick="joinGame()" id="join-btn">START</button>
                <button onclick="joinRandom()" id="rand-btn" style="background:#444;">RANDOM</button>
            </div>
        </div>
        <div style="color:#aaa; font-size:0.8rem;">LOBBY CHAT</div>
        <div style="background:#111; width:300px; height:150px; overflow-y:auto; padding:5px; border-radius:8px;" id="lobby-log"></div>
        <div style="display:flex; width:300px; gap:5px;">
            <input id="lobby-in" placeholder="Chat..." style="background:#222; border:none; color:#fff; padding:8px; flex:1;">
            <button onclick="sendLobby()" style="padding:0 15px; background:#444; border:none; color:#fff;">TX</button>
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <div id="game-view">
            <!-- UNO -->
            <div id="uno-table">
                <div id="color-ring" class="color-ring"></div>
                
                <div class="opp-container" id="uno-opponents"></div>
                
                <div class="center-area">
                    <div class="uno-card u-back" onclick="socket.emit('unoDraw', {room:roomID})">
                        <span style="font-size:1rem;">DRAW</span>
                    </div>
                    <div id="uno-pile"></div>
                </div>

                <div class="my-hand" id="uno-hand"></div>
                
                <div id="color-picker">
                    <div class="cp-btn u-red" onclick="pickColor('red')"></div>
                    <div class="cp-btn u-blue" onclick="pickColor('blue')"></div>
                    <div class="cp-btn u-green" onclick="pickColor('green')"></div>
                    <div class="cp-btn u-yellow" onclick="pickColor('yellow')"></div>
                </div>
            </div>

            <!-- BJ -->
            <div id="bj-table">
                <div style="margin:10px; color:#aaa;" id="bj-info">ROUND -/-</div>
                <div>DEALER</div>
                <div class="bj-cards" id="d-hand"></div>
                <div id="bj-seats"></div>
                <div id="bet-overlay" style="position:absolute; background:rgba(0,0,0,0.9); width:100%; height:100%; display:none; flex-direction:column; align-items:center; justify-content:center; z-index:50;">
                    <h2 style="color:white;">BET</h2>
                    <input type="range" id="bet-slider" min="10" max="1000" step="10" style="width:200px;" oninput="$('bet-val').innerText=this.value">
                    <div id="bet-val" style="color:#fff; font-size:2rem; margin:10px;">10</div>
                    <button onclick="placeBet()" style="padding:10px 30px; font-weight:bold; background:var(--accent); border:none; border-radius:20px;">CONFIRM</button>
                </div>
            </div>

            <div id="sys-msg"></div>
        </div>

        <div id="sidebar">
            <div style="padding:10px; background:rgba(255,255,255,0.05); display:flex; justify-content:space-between;">
                <span>CREDITS</span>
                <span id="wealth" style="font-weight:bold; color:var(--accent);">---</span>
            </div>
            <div style="display:flex;">
                <button onclick="tab('global')" style="flex:1; background:none; border:none; color:#888;" id="t-global">GLOBAL</button>
                <button onclick="tab('room')" style="flex:1; background:none; border:none; color:#fff; border-bottom:2px solid var(--accent);" id="t-room">ROOM</button>
            </div>
            <div id="c-global" class="chat-content" style="display:none;"></div>
            <div id="c-room" class="chat-content"></div>
            <div class="input-area">
                <input id="chat-in" placeholder="..." onkeydown="if(event.key==='Enter')sendChat()">
                <button class="tx" onclick="sendChat()">➤</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        // UID handling: preserve identity across sessions
        let localUid = localStorage.getItem('nita_uid');
        if(!localUid) { localUid = `${Date.now()}-${Math.floor(Math.random()*1000000)}`; localStorage.setItem('nita_uid', localUid); }
        // Prefill username if available
        const storedName = localStorage.getItem('nita_username');
        if(storedName) document.getElementById('username').value = storedName;

        let roomID='', myUser='', pendingI=-1, myTurn=false;
        let selectedCards = []; // array of card ids (or indexes as string) selected for bulk play
        let selectedColorChoices = {}; // map cardId -> color for wilds
        const $ = id => document.getElementById(id);

        // CHAT
        function sendLobby() { const t=$('lobby-in').value; if(t){socket.emit('sendChat',{type:'global',username:$('username').value,text:t});$('lobby-in').value='';} }
        function sendChat() { 
            const t=$('chat-in').value; 
            const type = $('t-global').style.borderBottom ? 'global' : 'room';
            if(t){socket.emit('sendChat',{type, room:roomID, username:myUser, text:t});$('chat-in').value='';} 
        }
        function tab(t) { 
            $('t-global').style.borderBottom = t==='global'?'2px solid var(--accent)':'none'; $('t-global').style.color=t==='global'?'#fff':'#888';
            $('t-room').style.borderBottom = t==='room'?'2px solid var(--accent)':'none'; $('t-room').style.color=t==='room'?'#fff':'#888';
            $('c-global').style.display = t==='global'?'block':'none'; $('c-room').style.display = t==='room'?'block':'none';
        }
        socket.on('chatMsg', m => {
            const h = `<div><strong style="color:${m.color||'#aaa'}">${m.username}</strong> ${m.text}</div>`;
            if(m.type==='global') { $('lobby-log').innerHTML+=h; $('c-global').innerHTML+=h; }
            if(m.type==='room') $('c-room').innerHTML+=h;
            ['lobby-log','c-global','c-room'].forEach(id=>$(id).scrollTop=$(id).scrollHeight);
        });

        // Receive initial chat history (for users who join later)
        socket.on('chatHistory', d => {
            if(!d || !Array.isArray(d.logs)) return;
            if(d.type === 'global') {
                d.logs.forEach(m => {
                    const h = `<div><strong style="color:${m.color||'#aaa'}">${m.username}</strong> ${m.text}</div>`;
                    $('lobby-log').innerHTML += h;
                    $('c-global').innerHTML += h;
                });
                ['lobby-log','c-global'].forEach(id=>$(id).scrollTop=$(id).scrollHeight);
            }
            // future: handle room-scoped history if server sends it
        });

        // JOIN
        function joinGame() {
            const b=$('join-btn'); b.disabled=true; b.innerText="WAIT...";
            myUser=$('username').value||'GUEST'; roomID=$('room').value;
            if(!roomID){alert("Room ID Required"); b.disabled=false; return;}
            // persist username locally
            localStorage.setItem('nita_username', myUser);
            socket.emit('joinRoom', {username:myUser, room:roomID, gameType:$('gameType').value, buyInAmount:$('buyin').value, uid: localUid});
        }

        function joinRandom() {
            const b = $('rand-btn'); b.disabled = true; b.innerText = 'CANCEL';
            myUser = $('username').value || 'GUEST';
            const gameType = $('gameType').value;
            const buyIn = $('buyin').value;
            localStorage.setItem('nita_username', myUser);
            socket.emit('joinRandom', { username: myUser, gameType, buyInAmount: buyIn, uid: localUid });
            // change behavior to cancel on next click
            b.onclick = () => leaveRandom();
        }

        function leaveRandom() {
            const b = $('rand-btn');
            const gameType = $('gameType').value; const buyIn = $('buyin').value;
            socket.emit('leaveRandom', { gameType, buyInAmount: buyIn });
            b.disabled = false; b.innerText = 'RANDOM';
            b.onclick = () => joinRandom();
        }
        socket.on('joined', d => {
            $('login-modal').style.display='none'; $('main-app').style.display='flex'; $('wealth').innerText=d.wealth;
            if(d.room) roomID = d.room;
            if(d.relief) alert("Relief funds applied!");
            // store username persistently
            if(myUser) localStorage.setItem('nita_username', myUser);
        });
        socket.on('error', m => { alert(m); $('join-btn').disabled=false; $('join-btn').innerText="START"; });

        // ROUTING
        socket.on('roomUpdate', d => {
            if(d.gameType==='uno') { $('uno-table').style.display='block'; $('bj-table').style.display='none'; renderUnoLobby(d.players); }
            else { $('uno-table').style.display='none'; $('bj-table').style.display='flex'; renderBjLobby(d.players); }
        });

        // UNO UI
        function renderUnoLobby(ps) {
            const m=ps.find(p=>p.username===myUser);
            if(!m.ready && (!m.unoHand||m.unoHand.length===0)) $('sys-msg').innerHTML=`<button onclick="socket.emit('toggleReady',{room:roomID})">READY?</button>`;
            else $('sys-msg').innerHTML= m.ready ? "WAITING..." : "";
        }
        socket.on('unoUpdate', d => {
            myTurn = d.isMyTurn;
            const ops = d.players.filter(p=>p.username!==myUser);
            $('uno-opponents').innerHTML = ops.map(p => `
                <div class="opp-card ${p.isTurn?'turn':''}">
                    <div class="opp-name">${p.username}</div>
                    <div class="opp-count">${p.handCount}</div>
                </div>`).join('');
            
            const top = d.topCard;
            const cc = `u-${d.currentColor}`;
            let txt = formatUnoText(top.type);
            
            $('uno-pile').innerHTML = `<div class="uno-card ${cc}"><span>${txt}</span></div>`;
            $('color-ring').className = `color-ring ring-${d.currentColor}`;

            $('uno-hand').innerHTML = d.myHand.map((c, i) => {
                const cid = c.id || `${i}`;
                const isSelected = selectedCards.includes(String(cid));
                const ccc = c.color==='black'?'u-black':`u-${c.color}`;
                const t = formatUnoText(c.type);
                const long = t.length > 1 ? 'long-text' : '';

                // determine playability for client-side disabling
                const top = d.topCard || {};
                const drawStack = d.drawStack || 0;
                function isPlayable(card) {
                    if(drawStack > 0) {
                        if(top.type === 'draw2' && card.type === 'draw2') return true;
                        if(top.type === 'draw4' && card.type === 'draw4') return true;
                        return false;
                    }
                    if(card.color === 'black') return true;
                    if(card.color === d.currentColor) return true;
                    if(card.type === top.type) return true;
                    return false;
                }

                const playable = isPlayable(c);
                const disabledClass = playable ? '' : 'disabled';
                const badge = isSelected ? `<div class="select-badge">${selectedCards.indexOf(String(cid))+1}</div>` : '';
                return `<div class="hand-card-wrapper" style="position:relative;"><div data-id="${cid}" id="card-${i}" class="uno-card ${ccc} ${long} ${isSelected?'selected':''} ${disabledClass}" onclick="toggleSelect('${cid}','${c.type}',${i})"><span>${t}</span>${badge}</div></div>`;
            }).join('');
            
            if(d.isMyTurn) $('sys-msg').innerText = "YOUR TURN";
            else $('sys-msg').innerText = "";
        });

        function formatUnoText(type) {
            if(type==='draw2') return '+2';
            if(type==='draw4') return '+4';
            if(type==='wild') return '★'; // Wild Icon
            if(type==='skip') return '⊘';
            if(type==='reverse') return '⇄';
            return type.toUpperCase();
        }

        function toggleSelect(cardId, type, index) {
            if(!myTurn) return;
            cardId = String(cardId);
            // prevent selecting disabled cards
            const el = document.querySelector(`#uno-hand [data-id="${cardId}"]`);
            if(el && el.classList.contains('disabled')) { 
                // brief feedback
                el.classList.add('invalid-move'); setTimeout(()=>el.classList.remove('invalid-move'),300);
                return;
            }
            const pos = selectedCards.indexOf(cardId);
            if(pos !== -1) {
                selectedCards.splice(pos, 1);
                delete selectedColorChoices[cardId];
            } else {
                if(type === 'wild' || type === 'draw4') {
                    // need color choice before adding
                    pendingI = cardId;
                    $('color-picker').style.display = 'flex';
                } else {
                    selectedCards.push(cardId);
                    // visual pop animation for newly selected card
                    const el = document.querySelector(`#uno-hand [data-id="${cardId}"]`);
                    if(el) {
                        // add temporary pop to badge (will be created in refreshHandSelection)
                        setTimeout(()=>{
                            const b = el.querySelector('.select-badge');
                            if(b) { b.classList.remove('pop'); void b.offsetWidth; b.classList.add('pop'); }
                        }, 60);
                        el.classList.add('selected');
                    }
                }
            }
            refreshHandSelection();
            refreshEndTurnButton();
        }

        function refreshHandSelection() {
            // update DOM classes
            const wrappers = document.querySelectorAll('#uno-hand [data-id]');
            wrappers.forEach(el => {
                const id = String(el.getAttribute('data-id'));
                const isSel = selectedCards.includes(id);
                el.classList.toggle('selected', isSel);
                // badge update
                let badge = el.querySelector('.select-badge');
                if(isSel) {
                    if(!badge) { badge = document.createElement('div'); badge.className='select-badge'; el.appendChild(badge); }
                    badge.innerText = String(selectedCards.indexOf(id) + 1);
                    // ensure pop animation when newly created
                    if(!badge.classList.contains('pop')) {
                        badge.classList.add('pop');
                        setTimeout(()=>badge.classList.remove('pop'), 350);
                    }
                } else {
                    if(badge) badge.remove();
                }
            });
        }

        function refreshEndTurnButton() {
            const btn = document.getElementById('end-turn-btn');
            if(myTurn && selectedCards.length>0) {
                if(!btn) {
                    const b = document.createElement('button'); b.id='end-turn-btn'; b.innerText='END TURN'; b.onclick = endTurnPlay; document.getElementById('sys-msg').appendChild(b);
                }
            } else if(btn) btn.remove();
        }
        
        // Invalid Move Feedback (Optional if server rejects silently, users might be confused)
        // Here we just assume client click = send. If invalid, nothing happens (server rejects).
        // To make it robust: 
        // サーバーが弾いた場合のエラーイベントがあれば良いですが、
        // 今回は「タップ時のアニメーション」で反応したことを伝えます。
        
        function pickColor(c) { 
            $('color-picker').style.display='none';
            if(pendingI === -1) return;
            // If pendingI is an index (number) from older flow, keep backward compatibility
            if(typeof pendingI === 'number') {
                socket.emit('unoMove', {room:roomID, cardIndex:pendingI, colorChoice:c});
            } else {
                // pendingI is cardId string for selection
                const cid = String(pendingI);
                selectedColorChoices[cid] = c;
                if(!selectedCards.includes(cid)) selectedCards.push(cid);
                pendingI = -1;
                refreshHandSelection(); refreshEndTurnButton();
            }
        }

        function endTurnPlay() {
            if(!myTurn || selectedCards.length===0) return;
            const colorChoices = selectedCards.map(id => selectedColorChoices[id] || null);
            socket.emit('unoMultiMove', { room: roomID, cardIds: selectedCards.slice(), colorChoices });
            // clear selection
            selectedCards = []; selectedColorChoices = {}; refreshHandSelection(); refreshEndTurnButton();
        }

        // BJ (Minified)
        function renderBjLobby(ps) { $('bj-seats').innerHTML=ps.map((p,i)=>`<div style="text-align:center; min-width:80px;"><div style="color:${p.color}">${p.username}</div><div>${p.score}</div><div id="h-${i}" class="bj-cards" style="transform:scale(0.8)"></div>${p.username===myUser&&!p.ready&&p.hand.length===0?`<button onclick="socket.emit('toggleReady',{room:roomID})" style="font-size:0.8rem; padding:5px;">READY</button>`:''}<div id="act-${i}"></div></div>`).join(''); }
        function placeBet(){ socket.emit('placeBet',{room:roomID, amount:$('bet-slider').value}); $('bet-overlay').style.display='none'; }
        socket.on('bjRoundStart',d=>{ $('bet-overlay').style.display='flex'; $('d-hand').innerHTML=''; $('bj-info').innerText=`ROUND ${d.round}`; });
        socket.on('ovRoundStart',d=>{ $('bet-overlay').style.display='flex'; $('d-hand').innerHTML=''; });
        socket.on('bjUpdate',d=>upCard(d,'bj')); socket.on('ovUpdate',d=>upCard(d,'ov'));
        function upCard(d,t){
            $('bet-overlay').style.display='none';
            $('d-hand').innerHTML=(d.dealerHand||[d.dealerCard]).map(c=>mkCard(c)).join('');
            d.players.forEach((p,i)=>{
                const div=$(`h-${i}`); if(div) div.innerHTML=p.hand.map(c=>mkCard(c)).join('');
                const act=$(`act-${i}`);
                if(act && p.username===myUser && i===d.turnIndex && d.phase==='playing') {
                    if(t==='bj') act.innerHTML=`<button onclick="socket.emit('bjAction',{room:roomID,action:'hit'})">HIT</button> <button onclick="socket.emit('bjAction',{room:roomID,action:'stand'})">STAY</button>`;
                    if(t==='ov') act.innerHTML=`<button onclick="socket.emit('ovAction',{room:roomID,choice:'high'})">HI</button> <button onclick="socket.emit('ovAction',{room:roomID,choice:'low'})">LO</button>`;
                } else if(act) act.innerHTML="";
            });
        }
        function mkCard(c){ if(!c.val&&!c.power)return''; const cl=['♥','♦'].includes(c.suit)?'red':'black'; return `<div class="bj-card ${cl}">${c.rank}${c.suit}</div>`; }
        
        socket.on('gameOver', d => { alert(d.msg); location.reload(); });
    </script>
</body>
</html>