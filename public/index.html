<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NITA GAME HUB // PROTOCOL 21</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* --- CORE & ANIMATIONS --- */
        :root {
            --bg: #050505; --text: #e0e0e0;
            --othello-green: #00ff41; --c4-red: #ff0055; --c4-cyan: #00eaff; --bj-gold: #ffd700;
        }
        body {
            background: var(--bg); color: var(--text); font-family: 'Courier New', monospace;
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center; overflow: hidden;
            background-image: linear-gradient(rgba(0,255,65,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,255,65,0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        /* Card Deal Animation */
        @keyframes dealCard {
            from { transform: translateY(-100vh) rotate(180deg); opacity: 0; }
            to { transform: translateY(0) rotate(0deg); opacity: 1; }
        }
        .card-anim { animation: dealCard 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }

        h1 { letter-spacing: 0.2em; text-shadow: 0 0 10px rgba(255,255,255,0.3); z-index: 10; cursor: pointer; }

        /* --- UI COMPONENTS --- */
        #login-screen {
            background: rgba(20,20,20,0.9); padding: 30px; border: 1px solid #333;
            display: flex; flex-direction: column; gap: 15px; z-index: 10; width: 400px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        input, select, button {
            background: #000; border: 1px solid #444; color: var(--text); padding: 10px;
            text-align: center; outline: none; width: 100%; text-transform: uppercase; font-family: inherit;
        }
        button:hover { background: var(--text); color: var(--bg); cursor: pointer; }

        #game-screen { display: none; flex-direction: row; gap: 40px; z-index: 10; }
        
        /* --- BLACKJACK TABLE --- */
        #blackjack-table {
            width: 800px; height: 600px; border: 2px solid #444; background: rgba(0,30,0,0.4);
            border-radius: 80px; position: relative; display: none;
        }
        
        .bj-info-hud {
            position: absolute; top: 10px; left: 20px;
            font-size: 1rem; color: var(--othello-green);
        }

        .bj-dealer-area { position: absolute; top: 40px; width: 100%; display: flex; justify-content: center; flex-direction: column; align-items: center; }
        
        .bj-seats { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-around; align-items: flex-end; }
        
        .bj-seat {
            width: 150px; min-height: 200px; border: 1px dashed #444; padding: 10px;
            background: rgba(0,0,0,0.6); transition: 0.3s; position: relative;
            display: flex; flex-direction: column; align-items: center;
        }
        .bj-seat.active-turn { border-color: #fff; background: rgba(50,50,50,0.6); box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .bj-seat.winner { border-color: var(--bj-gold); box-shadow: 0 0 20px var(--bj-gold); }

        .player-stats { font-size: 0.8rem; width: 100%; display: flex; justify-content: space-between; margin-bottom: 5px; color: #888; }
        .score-val { color: var(--bj-gold); }

        .card-container { display: flex; height: 90px; justify-content: center; }
        .bj-card {
            width: 50px; height: 75px; background: #eee; color: #000; border-radius: 4px;
            border: 1px solid #999; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.4rem; margin-left: -20px; box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            transition: transform 0.3s;
        }
        .bj-card:first-child { margin-left: 0; }
        .bj-card:hover { transform: translateY(-10px); z-index: 10; }
        .bj-card.red { color: #d00; }
        .bj-card.back { background: #333; color: #333; border-color: #555; background-image: repeating-linear-gradient(45deg, #333 0, #333 5px, #444 5px, #444 10px); }

        /* --- BETTING & CONTROLS --- */
        .bet-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; /* Toggled */
            align-items: center; justify-content: center; flex-direction: column; z-index: 50;
            border-radius: 80px;
        }
        .bet-buttons { display: flex; gap: 20px; margin-top: 20px; }
        .bet-btn {
            width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--bj-gold);
            background: #000; color: var(--bj-gold); font-weight: bold; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: 0.2s; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        .bet-btn:hover { background: var(--bj-gold); color: #000; transform: scale(1.1); }
        
        .action-bar { margin-top: 10px; display: flex; gap: 10px; }
        .action-bar button { padding: 5px 10px; width: auto; }

        /* Other styles omitted for brevity (Chat, Modal, etc.) - Assume same as before */
        .chat-container { border: 1px solid #333; background: rgba(0,20,0,0.6); padding: 10px; display: flex; flex-direction: column; width: 250px; }
        .chat-log { flex-grow: 1; overflow-y: auto; height: 200px; font-size: 0.8rem; border-bottom: 1px solid #333; }
        .msg-system { color: #ffaa00; font-style: italic; }
    </style>
</head>
<body>

    <h1>PROTOCOL 21</h1>

    <div id="login-screen">
        <div>// SYSTEM ACCESS</div>
        <input type="text" id="username" placeholder="CODENAME">
        <input type="text" id="room" placeholder="FREQUENCY (ROOM ID)">
        <select id="gameType">
            <option value="othello">TACTICS (OTHELLO)</option>
            <option value="connect4">GRAVITY (CONNECT 4)</option>
            <option value="blackjack">PROTOCOL 21 (BLACKJACK)</option>
        </select>
        <button onclick="joinGame()">INITIALIZE</button>
    </div>

    <div id="game-screen">
        <div id="blackjack-table">
            <div class="bj-info-hud" id="bj-hud">ROUND: -/-</div>
            
            <!-- BETTING OVERLAY -->
            <div class="bet-overlay" id="bet-overlay">
                <h2 style="color:#fff; text-shadow:0 0 10px #fff;">PLACE YOUR WAGER</h2>
                <div class="bet-buttons">
                    <div class="bet-btn" onclick="placeBet(2)">2</div>
                    <div class="bet-btn" onclick="placeBet(5)">5</div>
                    <div class="bet-btn" onclick="placeBet(10)">10</div>
                </div>
                <div style="margin-top:15px; font-size:0.8rem; color:#888;">TACTICAL SELECTION</div>
            </div>

            <div class="bj-dealer-area">
                <div style="margin-bottom:5px; color:#aaa; font-weight:bold;">DEALER (BOT)</div>
                <div id="dealer-cards" class="card-container"></div>
            </div>

            <div class="bj-seats" id="bj-seats-container"></div>
        </div>

        <!-- Chat / System Msg -->
        <div style="display:flex; flex-direction:column; gap:10px;">
            <div id="system-msg" style="color:#ff0055; min-height:20px;"></div>
            <div class="chat-container">
                <div class="chat-log" id="chat-log"></div>
                <input id="chat-input" placeholder="MSG..." onkeydown="if(event.key==='Enter')sendChat()">
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let mySeatIndex = -1;
        let roomID = '';
        let myPoints = 30;

        function joinGame() {
            const u = document.getElementById('username').value || 'ANONYMOUS';
            roomID = document.getElementById('room').value;
            const t = document.getElementById('gameType').value;
            if(!roomID) return alert("ROOM ID REQUIRED");
            socket.emit('joinRoom', { username: u, room: roomID, gameType: t });
        }

        function sendChat() {
            const i = document.getElementById('chat-input');
            if(i.value) { socket.emit('roomMsg', { room: roomID, username: document.getElementById('username').value, text: i.value }); i.value=''; }
        }
        socket.on('roomMsg', d => {
            const l = document.getElementById('chat-log');
            l.innerHTML += `<div><span style="color:${d.color||'#fff'}">[${d.username}]</span> ${d.text}</div>`;
            l.scrollTop = l.scrollHeight;
        });

        // --- BJ HANDLERS ---

        socket.on('roomUpdate', ({ players, gameType, maxRounds }) => {
            if(gameType !== 'blackjack') return; // Only focusing on BJ for this snippet
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('blackjack-table').style.display = 'block';
            renderSeats(players);
            
            // Lobby State
            const me = players.find(p => p.id === socket.id);
            if(!me.ready && players.every(p => !p.hand.length)) { // Simple check if game not started
                document.getElementById('system-msg').innerHTML = `
                    <button onclick="socket.emit('bjVoteStart', {room: roomID, rounds: 5})">VOTE: 5 ROUNDS</button>
                    <button onclick="socket.emit('bjVoteStart', {room: roomID, rounds: 10})">VOTE: 10 ROUNDS</button>
                    STATUS: WAITING FOR READY
                `;
            }
        });

        socket.on('bjRoundStart', ({ round, maxRounds }) => {
            document.getElementById('bj-hud').innerText = `ROUND: ${round}/${maxRounds}`;
            document.getElementById('system-msg').innerText = ">> BETTING PHASE OPEN <<";
            // Reset UI
            document.querySelectorAll('.card-container').forEach(e => e.innerHTML = '');
            document.getElementById('dealer-cards').innerHTML = '';
            // Show betting UI
            document.getElementById('bet-overlay').style.display = 'flex';
        });

        function placeBet(amt) {
            socket.emit('bjBet', { room: roomID, amount: amt });
            document.getElementById('bet-overlay').style.display = 'none';
            document.getElementById('system-msg').innerText = `>> WAGER LOCKED: ${amt} <<`;
        }

        socket.on('bjBetUpdate', ({ seatIndex, bet, score }) => {
            const s = document.getElementById(`score-${seatIndex}`);
            if(s) s.innerText = `${score}PTS (BET:${bet})`;
        });

        socket.on('bjUpdate', ({ players, dealerHand, turnIndex, phase }) => {
            document.getElementById('bet-overlay').style.display = 'none'; // Ensure closed
            
            // Dealer
            const dc = document.getElementById('dealer-cards');
            // Only redraw if count changed to avoid jitter, simplified here:
            dc.innerHTML = ''; 
            dealerHand.forEach((c, i) => dc.appendChild(createCard(c, i)));

            // Players
            players.forEach((p, i) => {
                const seat = document.getElementById(`seat-${i}`);
                const hc = document.getElementById(`hand-${i}`);
                const st = document.getElementById(`status-${i}`);
                const sc = document.getElementById(`score-${i}`);
                
                if(!seat) return;

                // Cards
                hc.innerHTML = '';
                p.hand.forEach((c, idx) => hc.appendChild(createCard(c, idx)));

                // Status/Score
                st.innerText = p.status === 'playing' ? '' : p.status.toUpperCase();
                sc.innerText = `${p.score}PTS (BET:${p.currentBet})`;
                if(p.status === 'bankrupt') st.innerText = "BANKRUPT";

                // Active Turn
                if(i === turnIndex && phase === 'playing') seat.classList.add('active-turn');
                else seat.classList.remove('active-turn');

                // Controls
                const ctrls = document.getElementById(`controls-${i}`);
                if(ctrls) ctrls.innerHTML = '';
                
                // Check if MY turn
                if(players[i].id === socket.id && i === turnIndex && phase === 'playing') {
                    if(ctrls) {
                        ctrls.innerHTML = `
                            <button onclick="socket.emit('bjAction',{room:roomID,action:'hit'})">HIT</button>
                            <button onclick="socket.emit('bjAction',{room:roomID,action:'stand'})">STAND</button>
                        `;
                    }
                    document.getElementById('system-msg').innerText = ">> YOUR ACTION REQUIRED <<";
                }
            });
        });

        socket.on('bjRoundOver', ({ dealerHand, players, isMatchOver }) => {
            // Reveal Dealer
            const dc = document.getElementById('dealer-cards');
            dc.innerHTML = '';
            dealerHand.forEach((c, i) => dc.appendChild(createCard(c, i)));

            // Results
            players.forEach((p, i) => {
                const st = document.getElementById(`status-${i}`);
                const sc = document.getElementById(`score-${i}`);
                if(st) st.innerHTML = `<span style="color:${p.result.includes('WIN')||p.result.includes('BJ') ? '#0f0':'#f00'}">${p.result}</span>`;
                if(sc) sc.innerText = `${p.score}PTS`;
            });

            document.getElementById('system-msg').innerText = isMatchOver ? "MATCH FINISHED. CALCULATING..." : "ROUND COMPLETE. PREPARING NEXT ROUND...";
        });

        socket.on('gameOver', ({ msg }) => {
            document.getElementById('bet-overlay').style.display = 'none';
            alert(msg);
            location.reload();
        });

        // --- HELPERS ---

        function renderSeats(players) {
            const c = document.getElementById('bj-seats-container');
            c.innerHTML = '';
            players.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'bj-seat';
                div.id = `seat-${i}`;
                div.innerHTML = `
                    <div style="color:${p.color}; font-weight:bold;">${p.username}</div>
                    <div class="player-stats">
                        <span id="score-${i}" class="score-val">${p.score}PTS</span>
                    </div>
                    <div class="card-container" id="hand-${i}"></div>
                    <div style="margin-top:5px; font-weight:bold;" id="status-${i}">${p.ready?'READY':'WAITING'}</div>
                    <div class="action-bar" id="controls-${i}"></div>
                `;
                c.appendChild(div);
            });
        }

        function createCard(c, index) {
            const div = document.createElement('div');
            div.className = `bj-card card-anim ${['♥','♦'].includes(c.suit)?'red':''}`;
            if(c.suit === '?') {
                div.classList.add('back');
            } else {
                div.innerText = `${c.rank}${c.suit}`;
            }
            div.style.animationDelay = `${index * 0.1}s`; // Staggered animation
            return div;
        }
    </script>
</body>
</html>