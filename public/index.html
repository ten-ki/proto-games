<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NITA GAMES // SYSTEM</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* --- CYBERPUNK AESTHETICS --- */
        :root {
            --bg-dark: #050505;
            --panel-bg: rgba(10, 15, 10, 0.85);
            --text-main: #e0e0e0;
            --accent-green: #00ff41;
            --accent-red: #ff0055;
            --accent-cyan: #00eaff;
            --accent-gold: #ffd700;
            --grid-line: rgba(0, 255, 65, 0.05);
        }

        body {
            margin: 0; height: 100vh;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Courier New', monospace;
            display: flex; flex-direction: column;
            overflow: hidden;
            /* Grid Background */
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* Scanline Overlay */
        body::after {
            content: " "; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 50; opacity: 0.5;
        }

        /* --- LAYOUT --- */
        /* Main container splitting Game (Left) and Chat (Right) */
        #main-interface {
            display: flex; width: 100%; height: 100%;
            padding: 20px; box-sizing: border-box; gap: 20px;
            position: relative; z-index: 10;
        }

        #game-viewport {
            flex: 3; /* Takes up 75% width */
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border: 1px solid #333; border-radius: 10px;
            background: var(--panel-bg);
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        #sidebar-panel {
            flex: 1; /* Takes up 25% width */
            display: flex; flex-direction: column;
            border: 1px solid #333; border-radius: 10px;
            background: rgba(0, 10, 0, 0.9);
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            min-width: 300px;
        }

        h1 {
            position: absolute; top: 10px; left: 20px; margin: 0;
            font-size: 2rem; letter-spacing: 0.2em;
            color: #fff; text-shadow: 0 0 10px var(--accent-green);
            pointer-events: none;
        }
        h1 span { font-size: 0.5em; color: #666; vertical-align: middle; }

        /* --- LOGIN SCREEN --- */
        #login-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 100; display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: #111; padding: 40px; border: 1px solid #444;
            display: flex; flex-direction: column; gap: 15px; width: 350px;
            box-shadow: 0 0 40px var(--accent-green);
            border-radius: 5px;
        }
        .login-box h2 { margin: 0 0 10px 0; text-align: center; font-size: 1rem; color: #888; letter-spacing: 0.3em; }

        /* --- INPUTS & BUTTONS --- */
        input, select, button {
            background: #000; border: 1px solid #444; color: var(--text-main);
            padding: 12px; font-family: inherit; font-size: 1rem; outline: none;
            text-transform: uppercase; transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--accent-green); box-shadow: 0 0 10px rgba(0,255,65,0.3); }
        
        button { cursor: pointer; font-weight: bold; letter-spacing: 0.1em; }
        button:hover { background: var(--accent-green); color: #000; box-shadow: 0 0 15px var(--accent-green); }
        
        .btn-secondary { border-color: #666; color: #888; }
        .btn-secondary:hover { background: #333; color: #fff; box-shadow: none; }

        /* --- CHAT (SIDEBAR) --- */
        .sidebar-header {
            padding: 10px; border-bottom: 1px solid #333;
            font-size: 0.8rem; color: #666; letter-spacing: 0.2em;
            background: rgba(0,20,0,0.5);
        }
        #chat-log {
            flex-grow: 1; overflow-y: auto; padding: 10px;
            font-size: 0.85rem; line-height: 1.4;
            scrollbar-width: thin; scrollbar-color: #444 #000;
        }
        .chat-entry { margin-bottom: 6px; word-wrap: break-word; animation: fadeIn 0.2s; }
        .user-tag { color: var(--accent-cyan); font-weight: bold; margin-right: 5px; }
        .sys-tag { color: var(--accent-gold); font-style: italic; }
        
        #chat-input-area { display: flex; border-top: 1px solid #333; }
        #chat-input { flex-grow: 1; border: none; padding: 15px; font-size: 0.9rem; }
        #chat-send { width: auto; border: none; border-left: 1px solid #333; color: var(--accent-green); }

        /* --- BOARD GAMES UI --- */
        .game-hud {
            margin-bottom: 20px; display: flex; gap: 40px;
            font-size: 1.5rem; text-transform: uppercase;
        }
        .p-label { opacity: 0.3; border-bottom: 2px solid transparent; padding: 5px; transition: 0.3s; }
        .p-active { opacity: 1; transform: scale(1.1); text-shadow: 0 0 10px currentColor; border-color: currentColor; }

        /* Othello */
        .othello-board {
            display: grid; grid-template-columns: repeat(8, 50px); gap: 2px;
            background: #111; padding: 5px; border: 2px solid #444;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .o-cell { width: 50px; height: 50px; background: #0a2a0a; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .o-cell:hover { background: #143f14; }
        .o-stone { width: 40px; height: 40px; border-radius: 50%; transition: transform 0.5s; }
        .o-black { background: #111; border: 1px solid #444; box-shadow: inset 2px 2px 5px rgba(255,255,255,0.2); }
        .o-white { background: #eee; box-shadow: 0 0 10px #fff; }
        .flipping { animation: flip 0.5s; } @keyframes flip { 0%{transform:rotateY(0)} 50%{transform:rotateY(90deg)} 100%{transform:rotateY(0)} }

        /* Connect 4 */
        .c4-board {
            position: relative; padding: 15px; border: 2px solid #444; border-radius: 10px;
            background: rgba(255,255,255,0.05); box-shadow: 0 0 30px rgba(0,0,0,0.5); cursor: pointer;
        }
        .c4-grid { display: grid; grid-template-columns: repeat(7, 60px); gap: 10px; position: relative; z-index: 10; pointer-events: none; }
        .c4-hole { width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.1); border-radius: 50%; }
        .c4-piece { position: absolute; width: 60px; height: 60px; border-radius: 50%; z-index: 5; transform: scale(0.9); }
        .c4-red { background: var(--accent-red); box-shadow: 0 0 15px var(--accent-red); }
        .c4-cyan { background: var(--accent-cyan); box-shadow: 0 0 15px var(--accent-cyan); }
        .falling { animation: drop 0.5s cubic-bezier(0.5, 0, 0.2, 1) forwards; } @keyframes drop { from{transform:translateY(-400px)} to{transform:translateY(0)} }

        /* --- BLACKJACK UI --- */
        #bj-table {
            width: 90%; height: 90%; position: relative;
            background: radial-gradient(circle at center, rgba(0,40,0,0.5), rgba(0,10,0,0.9));
            border-radius: 100px; border: 4px double #444;
            display: none; /* JS toggles */
        }
        .bj-dealer { position: absolute; top: 10%; width: 100%; display: flex; justify-content: center; flex-direction: column; align-items: center; }
        .bj-seats { position: absolute; bottom: 5%; width: 100%; display: flex; justify-content: space-around; align-items: flex-end; }
        
        .bj-seat {
            width: 140px; min-height: 180px; padding: 10px; border: 1px dashed #444;
            background: rgba(0,0,0,0.6); text-align: center; position: relative;
            transition: 0.3s; display: flex; flex-direction: column; align-items: center;
        }
        .bj-seat.active { border-color: #fff; box-shadow: 0 0 20px rgba(255,255,255,0.2); background: rgba(50,50,50,0.7); }
        .bj-info { font-size: 0.75rem; color: #aaa; margin-top: 5px; }
        .bj-score { color: var(--accent-gold); font-weight: bold; font-size: 1rem; }

        .cards { display: flex; justify-content: center; height: 70px; margin-top: 5px; }
        .card {
            width: 45px; height: 65px; background: #eee; color: #000; border-radius: 4px;
            display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.2rem;
            border: 1px solid #888; margin-left: -20px; box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            animation: deal 0.4s ease-out forwards;
        }
        .card:first-child { margin-left: 0; }
        .card.red { color: #d00; }
        .card.back { background: #222; border-color: #444; background-image: repeating-linear-gradient(45deg, #333 0, #333 5px, #444 5px, #444 10px); }
        @keyframes deal { from{opacity:0; transform:translateY(-50px) rotate(10deg);} to{opacity:1; transform:translateY(0) rotate(0);} }

        /* BJ Betting Overlay */
        #bet-ui {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); z-index: 20; border-radius: 90px;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .chips { display: flex; gap: 20px; margin-top: 20px; }
        .chip {
            width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--accent-gold);
            background: #000; color: var(--accent-gold); display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.2rem; cursor: pointer; transition: 0.2s;
            box-shadow: 0 0 10px var(--accent-gold);
        }
        .chip:hover { background: var(--accent-gold); color: #000; transform: scale(1.1); }

        /* --- SYSTEM MESSAGES --- */
        #sys-msg-overlay {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            color: #fff; font-size: 1.2rem; text-shadow: 0 0 10px rgba(255,255,255,0.8);
            pointer-events: none; z-index: 30; text-align: center;
        }

        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    </style>
</head>
<body>

    <!-- LOGIN MODAL -->
    <div id="login-overlay">
        <div class="login-box">
            <h1>NITA GAMES <span>// SYSTEM LOGIN</span></h1>
            <input type="text" id="username" placeholder="CODENAME" maxlength="10">
            <input type="text" id="room" placeholder="FREQUENCY (ROOM ID)">
            <select id="gameType">
                <option value="othello">TACTICS (OTHELLO)</option>
                <option value="connect4">GRAVITY (CONNECT 4)</option>
                <option value="blackjack">PROTOCOL 21 (BLACKJACK)</option>
            </select>
            <button onclick="joinGame()">INITIALIZE LINK</button>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="main-interface" style="display:none;">
        <h1>NITA GAMES</h1>

        <!-- GAME AREA (LEFT) -->
        <div id="game-viewport">
            <!-- 1v1 HUD -->
            <div class="game-hud" id="vs-hud" style="display:none;">
                <div id="p1-lbl" class="p-label">PLAYER 1</div>
                <div id="p2-lbl" class="p-label">PLAYER 2</div>
            </div>
            
            <div id="board-container"></div> <!-- Othello/C4 -->

            <!-- BLACKJACK TABLE -->
            <div id="bj-table">
                <div style="position:absolute; top:20px; left:30px; color:var(--accent-green);" id="bj-round-info">ROUND: -/-</div>
                
                <div id="bet-ui">
                    <h2 style="color:#fff;">PLACE WAGER</h2>
                    <div class="chips">
                        <div class="chip" onclick="sendBet(2)">2</div>
                        <div class="chip" onclick="sendBet(5)">5</div>
                        <div class="chip" onclick="sendBet(10)">10</div>
                    </div>
                </div>

                <div class="bj-dealer">
                    <div style="font-size:0.8rem; color:#666;">DEALER (BOT)</div>
                    <div class="cards" id="d-cards"></div>
                </div>
                <div class="bj-seats" id="bj-seats"></div>
            </div>

            <div id="sys-msg-overlay"></div>
        </div>

        <!-- SIDEBAR (RIGHT): CHAT & LOGS -->
        <div id="sidebar-panel">
            <div class="sidebar-header">// COMMS & LOGS</div>
            <div id="chat-log"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="TRANSMIT MESSAGE..." onkeydown="if(event.key==='Enter') sendChat()">
                <button id="chat-send" onclick="sendChat()">TX</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let roomID = '';
        let myUser = '';
        let myColor = '';
        let gameType = '';
        let mySeat = -1;

        // --- CORE FUNCTIONS ---
        function joinGame() {
            myUser = document.getElementById('username').value || 'ANONYMOUS';
            roomID = document.getElementById('room').value;
            gameType = document.getElementById('gameType').value;
            if(!roomID) return alert("ROOM ID REQUIRED");
            
            socket.emit('joinRoom', { username: myUser, room: roomID, gameType });
        }

        function sendChat() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();
            if(txt) {
                socket.emit('roomMsg', { room: roomID, username: myUser, text: txt, color: myColor });
                inp.value = '';
            }
        }

        function logChat(user, text, color, isSys) {
            const div = document.createElement('div');
            div.className = 'chat-entry';
            if(isSys) {
                div.innerHTML = `<span class="sys-tag">[SYSTEM]</span> <span style="color:#ccc">${text}</span>`;
            } else {
                const c = color === 'black' ? '#aaa' : (color === 'white' ? '#fff' : color);
                div.innerHTML = `<span class="user-tag" style="color:${c}">[${user}]</span> <span style="color:#ddd">${text}</span>`;
            }
            const log = document.getElementById('chat-log');
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        // --- SOCKET EVENTS ---
        socket.on('roomMsg', d => logChat(d.username, d.text, d.color, false));
        
        socket.on('joined', d => {
            myColor = d.color;
            gameType = d.gameType;
            mySeat = d.mySeat;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-interface').style.display = 'flex';
            logChat('SYS', 'CONNECTION ESTABLISHED', null, true);
        });

        socket.on('roomUpdate', d => {
            if(d.gameType === 'blackjack') {
                document.getElementById('vs-hud').style.display = 'none';
                document.getElementById('board-container').innerHTML = '';
                document.getElementById('bj-table').style.display = 'block';
                renderBjSeats(d.players);
                
                // Lobby Logic
                const me = d.players.find(p => p.id === socket.id);
                if(!me.ready && d.players.every(p => p.hand.length === 0)) {
                    document.getElementById('sys-msg-overlay').innerHTML = `
                        <button class="btn-secondary" onclick="socket.emit('bjVoteStart',{room:roomID,rounds:5})">VOTE: 5 ROUNDS</button>
                        <button class="btn-secondary" onclick="socket.emit('bjVoteStart',{room:roomID,rounds:10})">VOTE: 10 ROUNDS</button>
                    `;
                } else {
                    document.getElementById('sys-msg-overlay').innerHTML = '';
                }
            }
        });

        socket.on('gameStart', d => {
            logChat('SYS', `GAME START: ${d.p1} VS ${d.p2}`, null, true);
            if(d.gameType !== 'blackjack') {
                document.getElementById('bj-table').style.display = 'none';
                document.getElementById('vs-hud').style.display = 'flex';
                document.getElementById('p1-lbl').innerText = d.p1;
                document.getElementById('p2-lbl').innerText = d.p2;
                
                if(d.gameType === 'othello') renderOthello(d.board);
                else setupC4();
                updateTurn(d.turn);
            }
        });

        // --- BJ UI ---
        function renderBjSeats(players) {
            const c = document.getElementById('bj-seats');
            c.innerHTML = '';
            players.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'bj-seat';
                div.id = `seat-${i}`;
                div.innerHTML = `
                    <div style="color:${p.color}; font-weight:bold;">${p.username}</div>
                    <div class="bj-score">${p.score}PTS</div>
                    <div class="bj-info">BET: ${p.currentBet}</div>
                    <div class="cards" id="hand-${i}"></div>
                    <div class="bj-info" id="status-${i}" style="color:#fff;">${p.ready?'READY':''}</div>
                    <div id="ctrl-${i}" style="margin-top:auto;"></div>
                `;
                c.appendChild(div);
                
                // Re-render cards if exists
                const hc = div.querySelector(`#hand-${i}`);
                if(p.hand) p.hand.forEach(cd => hc.appendChild(createCard(cd)));
            });
        }

        function createCard(c) {
            const el = document.createElement('div');
            el.className = `card ${['♥','♦'].includes(c.suit)?'red':''}`;
            if(c.suit === '?') el.classList.add('back');
            else el.innerText = c.rank + c.suit;
            return el;
        }

        function sendBet(amt) {
            socket.emit('bjBet', { room: roomID, amount: amt });
            document.getElementById('bet-ui').style.display = 'none';
        }

        socket.on('bjRoundStart', d => {
            document.getElementById('bj-round-info').innerText = `ROUND: ${d.round}/${d.maxRounds}`;
            document.getElementById('bet-ui').style.display = 'flex';
            document.getElementById('d-cards').innerHTML = '';
            logChat('SYS', `ROUND ${d.round} START`, null, true);
        });

        socket.on('bjBetUpdate', d => {
            // Simple re-render handled by bjUpdate mainly, but log it
            // logChat('SYS', `Seat ${d.seatIndex} bet ${d.bet}`, null, true);
        });

        socket.on('bjUpdate', d => {
            document.getElementById('bet-ui').style.display = 'none';
            const dc = document.getElementById('d-cards');
            dc.innerHTML = ''; d.dealerHand.forEach(c => dc.appendChild(createCard(c)));

            d.players.forEach((p, i) => {
                const hc = document.getElementById(`hand-${i}`);
                if(hc) {
                    hc.innerHTML = '';
                    p.hand.forEach(c => hc.appendChild(createCard(c)));
                }
                const st = document.getElementById(`status-${i}`);
                if(st) st.innerText = p.status === 'playing' ? '' : p.status;
                
                const seat = document.getElementById(`seat-${i}`);
                if(seat) {
                    if(i === d.turnIndex && d.phase === 'playing') seat.classList.add('active');
                    else seat.classList.remove('active');
                    
                    // Controls
                    const ctrl = document.getElementById(`ctrl-${i}`);
                    ctrl.innerHTML = '';
                    if(p.id === socket.id && i === d.turnIndex && d.phase === 'playing') {
                        ctrl.innerHTML = `
                            <button onclick="socket.emit('bjAction',{room:roomID,action:'hit'})">HIT</button>
                            <button onclick="socket.emit('bjAction',{room:roomID,action:'stand'})">STAND</button>
                        `;
                    }
                }
            });
        });

        socket.on('bjRoundOver', d => {
            const dc = document.getElementById('d-cards');
            dc.innerHTML = ''; d.dealerHand.forEach(c => dc.appendChild(createCard(c)));
            
            d.players.forEach((p, i) => {
                const st = document.getElementById(`status-${i}`);
                if(st) {
                    st.innerText = p.result;
                    st.style.color = p.result.includes('WIN') ? '#0f0' : (p.result.includes('LOSE') ? '#f00' : '#fff');
                }
                // Update HUD Score
                const seat = document.getElementById(`seat-${i}`);
                if(seat) seat.querySelector('.bj-score').innerText = `${p.score}PTS`;
            });
            
            const txt = d.isMatchOver ? "MATCH COMPLETE" : "ROUND END";
            document.getElementById('sys-msg-overlay').innerText = txt;
        });

        // --- OTHELLO / C4 RENDERERS (Condensed) ---
        function updateTurn(turn) {
            const isP1 = (turn === 'black' || turn === 'red');
            document.getElementById('p1-lbl').className = isP1 ? 'p-label p-active' : 'p-label';
            document.getElementById('p2-lbl').className = !isP1 ? 'p-label p-active' : 'p-label';
            
            let c = 'white';
            if(gameType === 'connect4') {
                c = turn === 'red' ? 'var(--accent-red)' : 'var(--accent-cyan)';
            }
            document.getElementById('p1-lbl').style.color = isP1 ? c : '#666';
            document.getElementById('p2-lbl').style.color = !isP1 ? c : '#666';
        }

        function renderOthello(b) {
            const bc = document.getElementById('board-container'); bc.innerHTML = '';
            const div = document.createElement('div'); div.className = 'othello-board';
            for(let y=0;y<8;y++)for(let x=0;x<8;x++){
                const c = document.createElement('div'); c.className = 'o-cell';
                c.onclick = () => socket.emit('othelloMove', {room:roomID, x, y, color:myColor});
                if(b[y][x]) { const s=document.createElement('div'); s.className=`o-stone o-${b[y][x]} flipping`; c.appendChild(s); }
                div.appendChild(c);
            }
            bc.appendChild(div);
        }

        function setupC4() {
            const bc = document.getElementById('board-container'); bc.innerHTML = '';
            const c4 = document.createElement('div'); c4.className = 'c4-board';
            const g = document.createElement('div'); g.className = 'c4-grid';
            for(let i=0;i<42;i++) g.appendChild(document.createElement('div')).className='c4-hole';
            c4.appendChild(g); bc.appendChild(c4);
            
            c4.addEventListener('click', (e) => {
                const r = c4.getBoundingClientRect();
                const col = Math.floor((e.clientX - r.left - 15) / 70);
                if(col >= 0 && col < 7) socket.emit('connect4Move', {room:roomID, col});
            });
        }
        socket.on('othelloUpdate', d => renderOthello(d.board));
        socket.on('connect4Update', d => {
            const p = document.createElement('div');
            p.className = `c4-piece c4-${d.color === 'red' ? 'red' : 'cyan'} falling`;
            p.style.left = (15 + d.col * 70) + 'px';
            p.style.top = (15 + d.row * 70) + 'px';
            document.querySelector('.c4-board').appendChild(p);
        });
        socket.on('changeTurn', t => updateTurn(t));
        socket.on('gameOver', d => {
            alert(d.msg);
            location.reload();
        });
        socket.on('error', m => alert(m));

    </script>
</body>
</html>