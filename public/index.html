<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NITA GAMES</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #121212;
            --panel: rgba(30, 30, 30, 0.6);
            --text: #ffffff;
            --accent: #00E676;
            --uno-red: #FF5252; --uno-blue: #448AFF; --uno-green: #69F0AE; --uno-yellow: #FFD740;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background: radial-gradient(circle at center, #1a1a2e, #000);
            color: var(--text); font-family: 'Outfit', sans-serif;
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- LAYOUT --- */
        #main-app { display: flex; width: 100%; height: 100%; padding: 10px; gap: 10px; }
        
        /* Game View (Left/Top) */
        #game-view { 
            flex: 1; border-radius: 16px; background: var(--panel); 
            position: relative; overflow: hidden; 
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column;
        }

        /* Sidebar (Right/Bottom) */
        #sidebar { 
            width: 300px; border-radius: 16px; background: var(--panel);
            border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column;
            /* Mobile adjustments done in media query */
        }

        /* --- UNO UI --- */
        #uno-table { width: 100%; height: 100%; position: relative; display: none; }

        /* Opponents (Top Arch) */
        .opp-container {
            position: absolute; top: 10px; width: 100%; height: 120px;
            display: flex; justify-content: center; gap: 10px; z-index: 10;
        }
        .opp-card {
            background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2); text-align: center;
            min-width: 70px; display: flex; flex-direction: column; justify-content: center;
            transition: 0.3s;
        }
        .opp-card.turn { border-color: var(--accent); box-shadow: 0 0 15px var(--accent); background: rgba(0, 230, 118, 0.1); transform: scale(1.05); }
        .opp-name { font-size: 0.7rem; color: #aaa; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80px; }
        .opp-count { font-size: 1.5rem; font-weight: 800; color: #fff; transition: transform 360ms cubic-bezier(.2,.9,.2,1), opacity 260ms ease; }
        .opp-count.count-pop { transform: translateY(-8px) scale(1.12); opacity:0.92; }
        .opp-count.count-down { color:#ff8a80; }
        .opp-count.count-up { color:#a7ffeb; }
        .opp-card.turn-flash { animation: turnblink 900ms ease; }
        @keyframes turnblink { 0%{ transform: translateY(0) scale(1); box-shadow: 0 0 6px rgba(0,230,118,0.12);} 40%{ transform: translateY(-6px) scale(1.06); box-shadow: 0 0 30px rgba(0,230,118,0.24);} 100%{ transform: translateY(0) scale(1); } }
        .color-ring.turn-flash { animation: ringflash 900ms ease; }
        @keyframes ringflash { 0%{ box-shadow: 0 0 10px rgba(255,255,255,0.02);} 50%{ box-shadow: 0 0 40px rgba(255,255,255,0.12);} 100%{ box-shadow: 0 0 10px rgba(255,255,255,0.02);} }
        .skip-flash { animation: skipPop 900ms ease; }
        @keyframes skipPop { 0%{ transform: translateY(0) rotate(0); } 40%{ transform: translateY(-8px) rotate(-4deg); } 100%{ transform: translateY(0) rotate(0); } }
        .reverse-flip { animation: revSpin 900ms ease; }
        @keyframes revSpin { 0%{ transform: rotateY(0); } 50%{ transform: rotateY(180deg) scale(1.03); } 100%{ transform: rotateY(0); } }
        .color-ring.reverse-flash { animation: ringrev 900ms ease; }
        @keyframes ringrev { 0%{ box-shadow: 0 0 6px rgba(100,100,255,0.08);} 50%{ box-shadow: 0 0 48px rgba(100,100,255,0.32); } 100%{ box-shadow: 0 0 6px rgba(100,100,255,0.08);} }

        /* Center Pile (Draw & Play) */
        .center-area {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            display: flex; gap: 20px; align-items: center; z-index: 5;
        }
        /* Current Color Ring */
        .color-ring {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 220px; height: 160px; border-radius: 20px;
            border: 4px solid transparent; pointer-events: none; transition: 0.5s;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .ring-red { border-color: var(--uno-red); box-shadow: 0 0 30px var(--uno-red), inset 0 0 20px var(--uno-red); }
        .ring-blue { border-color: var(--uno-blue); box-shadow: 0 0 30px var(--uno-blue), inset 0 0 20px var(--uno-blue); }
        .ring-green { border-color: var(--uno-green); box-shadow: 0 0 30px var(--uno-green), inset 0 0 20px var(--uno-green); }
        .ring-yellow { border-color: var(--uno-yellow); box-shadow: 0 0 30px var(--uno-yellow), inset 0 0 20px var(--uno-yellow); }

        /* Cards */
        .uno-card {
            width: 80px; height: 120px; border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            font-weight: 900; color: white; border: 3px solid white;
            position: relative; user-select: none; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            background: #333; transition: transform 0.2s;
        }
        /* Card Content Sizing */
        .uno-card span { font-size: 2.5rem; }
        .uno-card.long-text span { font-size: 1.5rem; } /* Reduce font for wild/draw4 */
        
        .uno-card:active { transform: scale(0.95); } /* Touch Feedback */

        .uno-card.disabled { opacity: 0.45; filter: grayscale(0.35); cursor: not-allowed; transform:none; }

        .fly-card {
            position: absolute; width: 80px; height: 120px; border-radius:8px; z-index:9999; pointer-events:none;
            transition: transform 420ms cubic-bezier(.2,.9,.2,1), opacity 320ms ease;
        }
        
        .u-red { background: var(--uno-red); }
        .u-blue { background: var(--uno-blue); }
        .u-green { background: var(--uno-green); }
        .u-yellow { background: var(--uno-yellow); color: #333; text-shadow: none; border-color: #333; }
        .u-black { background: #111; border-color: #888; }
        .u-back { 
            background: linear-gradient(45deg, #111 25%, #222 25%, #222 50%, #111 50%, #111 75%, #222 75%, #222);
            background-size: 20px 20px; border: 3px solid #666;
        }

        /* My Hand */
        .my-hand {
            position: absolute; bottom: 20px; width: 100%; height: 140px;
            display: flex; justify-content: center; align-items: flex-end;
            padding: 0 20px; overflow-x: auto; overflow-y: hidden;
            z-index: 100; /* ★重要: 最前面に配置 */
        }
        .hand-card-wrapper {
            margin-left: clamp(-28px, -8vw, -45px); transition: 0.18s;
            flex-shrink: 0; width: clamp(56px, 12vw, 96px); height: clamp(86px, 19vw, 144px);
        }
        .hand-card-wrapper:first-child { margin-left: 0; }
        .hand-card-wrapper:hover, .hand-card-wrapper:active {
            transform: translateY(-18px); margin-right: 35px; z-index: 101;
        }
        .select-badge {
            position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.6);
            color: #fff; width: 22px; height: 22px; font-size: 0.8rem; display:flex; align-items:center; justify-content:center;
            border-radius: 50%; border: 2px solid rgba(255,255,255,0.6);
            pointer-events: none;
        }
        .select-badge.pop { animation: pop 260ms cubic-bezier(.2,.9,.2,1); }
        @keyframes pop { 0%{ transform: scale(0.6); opacity:0 } 60%{ transform: scale(1.15); opacity:1 } 100%{ transform: scale(1); } }

        .uno-card.selected { transform: translateY(-22px) scale(1.04); box-shadow: 0 10px 30px rgba(0,0,0,0.6); border-color: #fff; transition: transform 220ms ease, box-shadow 220ms ease; }

        .opp-card.turn { animation: pulse 1200ms infinite; }
        @keyframes pulse { 0%{ box-shadow: 0 0 8px rgba(0,230,118,0.14); transform: translateY(0) } 50%{ box-shadow: 0 0 18px rgba(0,230,118,0.22); transform: translateY(-4px) } 100%{ box-shadow: 0 0 8px rgba(0,230,118,0.14); transform: translateY(0) } }

        #uno-pile .uno-card { transition: transform 300ms ease, opacity 300ms ease; }
        #uno-pile.pop { animation: pilepop 320ms ease; }
        @keyframes pilepop { 0%{ transform: rotate(-8deg) scale(0.9); opacity:0 } 70%{ transform: rotate(2deg) scale(1.02); opacity:1 } 100%{ transform: rotate(0deg) scale(1); } }

        #sys-msg button { transition: transform 120ms ease, box-shadow 120ms ease; }
        #sys-msg button:active { transform: translateY(2px) scale(0.98); box-shadow: 0 6px 18px rgba(0,0,0,0.6); }

        /* Error Animation (Shake) */
        @keyframes shake {
            0% { transform: translateX(0); } 25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); }
        }
        .invalid-move { animation: shake 0.3s; border-color: red !important; }

        /* Color Picker Overlay */
        #color-picker {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); z-index: 200; display: none;
            align-items: center; justify-content: center; gap: 20px;
        }
        .cp-btn { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #fff; cursor: pointer; }

        /* --- BJ UI --- */
        #bj-table { width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .bj-cards { display: flex; gap: 5px; height: 90px; justify-content: center; margin-top: 5px; }
        .bj-card { width: 60px; height: 90px; background: white; color: black; border-radius: 6px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; font-weight: bold; border: 1px solid #ccc; }
        .bj-card.red { color: #e74c3c; }
        #bj-seats { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; width: 100%; padding: 10px; overflow-y: auto; }
        
        /* --- CHAT --- */
        .chat-content { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.85rem; background: rgba(0,0,0,0.3); }
        .input-area { display: flex; padding: 10px; gap: 5px; border-top: 1px solid rgba(255,255,255,0.1); }
        input { background: #222; border: none; color: white; padding: 10px; flex: 1; border-radius: 6px; }
        button.tx { background: var(--accent); color: black; border: none; padding: 0 15px; border-radius: 6px; font-weight: bold; }

        /* --- LOGIN MODAL --- */
        #login-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
        }
        .login-box {
            background: #222; padding: 30px; border-radius: 20px; width: 300px;
            display: flex; flex-direction: column; gap: 10px; border: 1px solid #444;
        }
        .login-box button { background: linear-gradient(90deg, #00C9FF, #92FE9D); border: none; padding: 15px; font-weight: bold; border-radius: 8px; margin-top: 10px; cursor: pointer; color: #000; }

        /* SYSTEM MSG */
        #sys-msg { 
            position: absolute; bottom: 160px; width: 100%; text-align: center; 
            pointer-events: none; z-index: 50; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); font-size: 1.2rem; font-weight: bold;
        }
        /* Make button inside sys-msg clickable */
        #sys-msg button { pointer-events: auto; padding: 10px 30px; font-size: 1.2rem; background: var(--accent); border: none; border-radius: 50px; box-shadow: 0 0 20px var(--accent); cursor: pointer; color: #000; font-weight: 800; }

        /* Mobile Responsive */
        @media (max-width: 980px) {
            #main-app { flex-direction: column; padding: 0; gap: 0; }
            #game-view { flex: 2; border-radius: 0; border: none; border-bottom: 1px solid #333; }
            #sidebar { flex: 1; border-radius: 0; min-width: auto; width: 100%; }
            .opp-container { height: auto; top: 8px; flex-wrap: wrap; gap:6px; }
            .opp-card { min-width: 60px; padding:6px 8px; }
            .my-hand { bottom: 8px; padding: 0 6px; height: 110px; }
            .hand-card-wrapper { width: clamp(56px, 14vw, 80px); height: clamp(86px, 19vw, 120px); margin-left: -30px; }
            .uno-card { width: clamp(56px, 13vw, 80px); height: clamp(86px, 19vw, 120px); font-size: clamp(1rem, 3.2vw, 2.5rem); border-width: 2px; }
            .uno-card span { font-size: clamp(1rem, 3vw, 2rem); }
            .center-area { transform: translate(-50%, -50%); } 
            .color-ring { width: clamp(120px, 32vw, 220px); height: clamp(100px, 24vw, 160px); }
            #sidebar { order: 2; }
            #game-view { order: 1; }
        }

        /* Large screens adjustments */
        @media (min-width: 1400px) {
            .hand-card-wrapper { margin-left: -45px; }
            .uno-card { width: 96px; height: 144px; }
        }

        /* Ensure container fits and doesn't overflow horizontally */
        #main-app { max-width: 1600px; margin: 0 auto; }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h2 style="text-align:center; color:white; margin:0;">NITA GAMES</h2>
            <input id="username" placeholder="NAME">
            <input id="room" placeholder="ROOM ID">
            <select id="gameType" style="padding:10px; background:#333; color:#fff; border:none; border-radius:6px;">
                <option value="uno">UNO (Max 6)</option>
                <option value="blackjack">BJ (Protocol 21)</option>
                <option value="override">OV (Hi&Lo)</option>
            </select>
            <input type="number" id="buyin" value="1000">
            <div style="display:flex; gap:8px;">
                <button onclick="joinGame()" id="join-btn">START</button>
                <button onclick="joinRandom()" id="rand-btn" style="background:#444;">RANDOM</button>
            </div>
        </div>
        <div style="color:#aaa; font-size:0.8rem;">LOBBY CHAT</div>
        <div style="background:#111; width:300px; height:150px; overflow-y:auto; padding:5px; border-radius:8px;" id="lobby-log"></div>
        <div style="display:flex; width:300px; gap:5px;">
            <input id="lobby-in" placeholder="Chat..." style="background:#222; border:none; color:#fff; padding:8px; flex:1;">
            <button onclick="sendLobby()" style="padding:0 15px; background:#444; border:none; color:#fff;">TX</button>
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <div id="game-view">
            <!-- UNO -->
            <div id="uno-table">
                <div id="color-ring" class="color-ring"></div>
                
                <div class="opp-container" id="uno-opponents"></div>
                
                <div class="center-area">
                    <div class="uno-card u-back" onclick="socket.emit('unoDraw', {room:roomID})">
                        <span style="font-size:1rem;">DRAW</span>
                    </div>
                    <div id="uno-pile"></div>
                </div>

                <div class="my-hand" id="uno-hand"></div>
                
                <div id="color-picker">
                    <div class="cp-btn u-red" onclick="pickColor('red')"></div>
                    <div class="cp-btn u-blue" onclick="pickColor('blue')"></div>
                    <div class="cp-btn u-green" onclick="pickColor('green')"></div>
                    <div class="cp-btn u-yellow" onclick="pickColor('yellow')"></div>
                </div>
            </div>

            <!-- BJ -->
            <div id="bj-table">
                <div style="margin:10px; color:#aaa;" id="bj-info">ROUND -/-</div>
                <div>DEALER</div>
                <div class="bj-cards" id="d-hand"></div>
                <div id="bj-seats"></div>
                <div id="bet-overlay" style="position:absolute; background:rgba(0,0,0,0.9); width:100%; height:100%; display:none; flex-direction:column; align-items:center; justify-content:center; z-index:50;">
                    <h2 style="color:white;">BET</h2>
                    <input type="range" id="bet-slider" min="10" max="1000" step="10" style="width:200px;" oninput="$('bet-val').innerText=this.value">
                    <div id="bet-val" style="color:#fff; font-size:2rem; margin:10px;">10</div>
                    <button onclick="placeBet()" style="padding:10px 30px; font-weight:bold; background:var(--accent); border:none; border-radius:20px;">CONFIRM</button>
                </div>
            </div>

            <div id="sys-msg"></div>
        </div>

        <div id="sidebar">
            <div style="padding:10px; background:rgba(255,255,255,0.05); display:flex; justify-content:space-between;">
                <span>CREDITS</span>
                <span id="wealth" style="font-weight:bold; color:var(--accent);">---</span>
            </div>
            <div style="display:flex;">
                <button onclick="tab('global')" style="flex:1; background:none; border:none; color:#888;" id="t-global">GLOBAL</button>
                <button onclick="tab('room')" style="flex:1; background:none; border:none; color:#fff; border-bottom:2px solid var(--accent);" id="t-room">ROOM</button>
            </div>
            <div id="c-global" class="chat-content" style="display:none;"></div>
            <div id="c-room" class="chat-content"></div>
            <div class="input-area">
                <input id="chat-in" placeholder="..." onkeydown="if(event.key==='Enter')sendChat()">
                <button class="tx" onclick="sendChat()">➤</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        // UID handling: preserve identity across sessions
        let localUid = localStorage.getItem('nita_uid');
        if(!localUid) { localUid = `${Date.now()}-${Math.floor(Math.random()*1000000)}`; localStorage.setItem('nita_uid', localUid); }
        // Prefill username if available
        const storedName = localStorage.getItem('nita_username');
        if(storedName) document.getElementById('username').value = storedName;

        let roomID='', myUser='', pendingI=-1, myTurn=false;
        let selectedCards = []; // array of card ids (or indexes as string) selected for bulk play
        let selectedColorChoices = {}; // map cardId -> color for wilds
        const $ = id => document.getElementById(id);
        let prevUnoPlayersMap = {}; // username -> handCount
        let prevTurnUsername = null;
        let lastPlayedDrawType = null;
        let unoCalledLocal = false;

        // CHAT
        function sendLobby() { const t=$('lobby-in').value; if(t){socket.emit('sendChat',{type:'global',username:$('username').value,text:t});$('lobby-in').value='';} }
        function sendChat() { 
            const t=$('chat-in').value; 
            const type = $('t-global').style.borderBottom ? 'global' : 'room';
            if(t){socket.emit('sendChat',{type, room:roomID, username:myUser, text:t});$('chat-in').value='';} 
        }
        function tab(t) { 
            $('t-global').style.borderBottom = t==='global'?'2px solid var(--accent)':'none'; $('t-global').style.color=t==='global'?'#fff':'#888';
            $('t-room').style.borderBottom = t==='room'?'2px solid var(--accent)':'none'; $('t-room').style.color=t==='room'?'#fff':'#888';
            $('c-global').style.display = t==='global'?'block':'none'; $('c-room').style.display = t==='room'?'block':'none';
        }
        socket.on('chatMsg', m => {
            const h = `<div><strong style="color:${m.color||'#aaa'}">${m.username}</strong> ${m.text}</div>`;
            if(m.type==='global') { $('lobby-log').innerHTML+=h; $('c-global').innerHTML+=h; }
            if(m.type==='room') $('c-room').innerHTML+=h;
            ['lobby-log','c-global','c-room'].forEach(id=>$(id).scrollTop=$(id).scrollHeight);
        });

        // Receive initial chat history (for users who join later)
        socket.on('chatHistory', d => {
            if(!d || !Array.isArray(d.logs)) return;
            if(d.type === 'global') {
                d.logs.forEach(m => {
                    const h = `<div><strong style="color:${m.color||'#aaa'}">${m.username}</strong> ${m.text}</div>`;
                    $('lobby-log').innerHTML += h;
                    $('c-global').innerHTML += h;
                });
                ['lobby-log','c-global'].forEach(id=>$(id).scrollTop=$(id).scrollHeight);
            }
            // future: handle room-scoped history if server sends it
        });

        // JOIN
        function joinGame() {
            const b=$('join-btn'); b.disabled=true; b.innerText="WAIT...";
            myUser=$('username').value||'GUEST'; roomID=$('room').value;
            if(!roomID){alert("Room ID Required"); b.disabled=false; return;}
            // persist username locally
            localStorage.setItem('nita_username', myUser);
            socket.emit('joinRoom', {username:myUser, room:roomID, gameType:$('gameType').value, buyInAmount:$('buyin').value, uid: localUid});
        }

        function joinRandom() {
            const b = $('rand-btn'); b.disabled = true; b.innerText = 'CANCEL';
            myUser = $('username').value || 'GUEST';
            const gameType = $('gameType').value;
            const buyIn = $('buyin').value;
            localStorage.setItem('nita_username', myUser);
            socket.emit('joinRandom', { username: myUser, gameType, buyInAmount: buyIn, uid: localUid });
            // change behavior to cancel on next click
            b.onclick = () => leaveRandom();
        }

        function leaveRandom() {
            const b = $('rand-btn');
            const gameType = $('gameType').value; const buyIn = $('buyin').value;
            socket.emit('leaveRandom', { gameType, buyInAmount: buyIn });
            b.disabled = false; b.innerText = 'RANDOM';
            b.onclick = () => joinRandom();
        }
        socket.on('joined', d => {
            $('login-modal').style.display='none'; $('main-app').style.display='flex'; $('wealth').innerText=d.wealth;
            if(d.room) roomID = d.room;
            if(d.relief) alert("Relief funds applied!");
            // store username persistently
            if(myUser) localStorage.setItem('nita_username', myUser);
        });
        socket.on('error', m => { alert(m); $('join-btn').disabled=false; $('join-btn').innerText="START"; });

        // ROUTING
        socket.on('roomUpdate', d => {
            if(d.gameType==='uno') { $('uno-table').style.display='block'; $('bj-table').style.display='none'; renderUnoLobby(d.players); }
            else { $('uno-table').style.display='none'; $('bj-table').style.display='flex'; renderBjLobby(d.players); }
        });

        // UNO UI
        function renderUnoLobby(ps) {
            const m=ps.find(p=>p.username===myUser);
            if(!m.ready && (!m.unoHand||m.unoHand.length===0)) $('sys-msg').innerHTML=`<button onclick="socket.emit('toggleReady',{room:roomID})">READY?</button>`;
            else $('sys-msg').innerHTML= m.ready ? "WAITING..." : "";
        }
        socket.on('unoUpdate', d => {
            myTurn = d.isMyTurn;
            const ops = d.players.filter(p=>p.username!==myUser);
            $('uno-opponents').innerHTML = ops.map(p => `
                <div class="opp-card ${p.isTurn?'turn':''}" data-username="${escapeHtml(p.username)}">
                    <div class="opp-name">${escapeHtml(p.username)}</div>
                    <div class="opp-count">${p.handCount}</div>
                </div>`).join('');
            
            const top = d.topCard;
            const cc = `u-${d.currentColor}`;
            let txt = formatUnoText(top.type);
            
            $('uno-pile').innerHTML = `<div class="uno-card ${cc}"><span>${txt}</span></div>`;
            $('color-ring').className = `color-ring ring-${d.currentColor}`;

            // --- animations for other players' plays and count changes ---
            // Check for handCount changes to animate plays
            d.players.forEach(p => {
                const prev = prevUnoPlayersMap[p.username];
                if(typeof prev !== 'undefined' && p.handCount < prev) {
                    // played card(s): animate one fly per decrement
                    const delta = prev - p.handCount;
                    for(let i=0;i<delta;i++) animateOpponentPlay(p.username);
                    // animate number change
                    animateCountChange(p.username, p.handCount);
                } else if(typeof prev !== 'undefined' && p.handCount > prev) {
                    // gained cards (draw) - animate increase
                    animateCountChange(p.username, p.handCount, true);
                }
            });

            // Turn change effect: flash when turn rotates
            const newTurnPlayer = d.players.find(p=>p.isTurn);
            if(newTurnPlayer) {
                if(prevTurnUsername && prevTurnUsername !== newTurnPlayer.username) {
                    // flash ring and highlight the new player's opp-card
                    flashTurn(newTurnPlayer.username);
                }
                prevTurnUsername = newTurnPlayer.username;
            }

            // update prev map
            prevUnoPlayersMap = {};
            d.players.forEach(p => prevUnoPlayersMap[p.username] = p.handCount);

            $('uno-hand').innerHTML = d.myHand.map((c, i) => {
                const cid = c.id || `${i}`;
                const isSelected = selectedCards.includes(String(cid));
                const ccc = c.color==='black'?'u-black':`u-${c.color}`;
                const t = formatUnoText(c.type);
                const long = t.length > 1 ? 'long-text' : '';

                // determine playability for client-side disabling
                const top = d.topCard || {};
                const drawStack = d.drawStack || 0;
                function isPlayable(card) {
                    if(drawStack > 0) {
                        if(top.type === 'draw2' && card.type === 'draw2') return true;
                        if(top.type === 'draw4' && card.type === 'draw4') return true;
                        return false;
                    }
                    if(card.color === 'black') return true;
                    if(card.color === d.currentColor) return true;
                    if(card.type === top.type) return true;
                    return false;
                }

                const playable = isPlayable(c);
                const disabledClass = playable ? '' : 'disabled';
                const badge = isSelected ? `<div class="select-badge">${selectedCards.indexOf(String(cid))+1}</div>` : '';
                return `<div class="hand-card-wrapper" style="position:relative;"><div data-id="${cid}" id="card-${i}" class="uno-card ${ccc} ${long} ${isSelected?'selected':''} ${disabledClass}" onclick="toggleSelect('${cid}','${c.type}',${i})"><span>${t}</span>${badge}</div></div>`;
            }).join('');
            
            if(d.isMyTurn) $('sys-msg').innerText = "YOUR TURN";
            else $('sys-msg').innerText = "";

            // show UNO call button when player has exactly 1 card
            const existingUnoBtn = document.getElementById('uno-call-btn');
            if(d.isMyTurn && d.myHand && d.myHand.length === 1) {
                if(!existingUnoBtn) {
                    const b = document.createElement('button'); b.id='uno-call-btn'; b.innerText='UNO!'; b.onclick = () => {
                        unoCalledLocal = true; socket.emit('unoCall', { room: roomID }); b.disabled = true; b.innerText='CALLED';
                    };
                    document.getElementById('sys-msg').appendChild(b);
                }
            } else if(existingUnoBtn) existingUnoBtn.remove();
        });

        function formatUnoText(type) {
            if(type==='draw2') return '+2';
            if(type==='draw4') return '+4';
            if(type==='wild') return '★'; // Wild Icon
            if(type==='skip') return '⊘';
            if(type==='reverse') return '⇄';
            return type.toUpperCase();
        }

        // helper: HTML escape for attributes
        function escapeHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

        function animateOpponentPlay(username) {
            // find opponent card area
            const el = document.querySelector(`#uno-opponents [data-username="${CSS.escape(username)}"]`);
            const pile = $('uno-pile').querySelector('.uno-card');
            if(!el || !pile) return;
            const rect = el.getBoundingClientRect();
            const pileRect = pile.getBoundingClientRect();

            const clone = document.createElement('div');
            clone.className = 'fly-card u-back';
            clone.style.left = rect.left + 'px'; clone.style.top = rect.top + 'px';
            clone.style.width = Math.min(70, rect.width) + 'px'; clone.style.height = Math.min(110, rect.height) + 'px';
            clone.style.position = 'absolute'; clone.style.opacity = '0.95';
            document.body.appendChild(clone);

            const dx = (pileRect.left + pileRect.width/2) - (rect.left + rect.width/2);
            const dy = (pileRect.top + pileRect.height/2) - (rect.top + rect.height/2);
            requestAnimationFrame(()=>{ clone.style.transform = `translate(${dx}px, ${dy}px) scale(0.9)`; clone.style.opacity='0.0'; });
            clone.addEventListener('transitionend', ()=>{ clone.remove(); });
            setTimeout(()=>{ if(document.body.contains(clone)) clone.remove(); }, 700);
        }


        function playDrawEffect(type) {
            const overlay = document.createElement('div'); overlay.style.position='fixed'; overlay.style.left=0; overlay.style.top=0; overlay.style.right=0; overlay.style.bottom=0; overlay.style.zIndex=2000; overlay.style.pointerEvents='none';
            overlay.innerHTML = `<div style="position:absolute;left:50%;top:20%;transform:translateX(-50%);padding:18px 26px;border-radius:12px;background:linear-gradient(90deg,#ff5252,#448aff);font-weight:800;color:#000;box-shadow:0 10px 40px rgba(0,0,0,0.6);">${type.toUpperCase()}!</div>`;
            document.body.appendChild(overlay);
            setTimeout(()=>{ overlay.style.transition='opacity 360ms ease'; overlay.style.opacity='0'; }, 600);
            setTimeout(()=>overlay.remove(), 1100);
        }

        function playChainEffect(type) {
            const overlay = document.createElement('div'); overlay.style.position='fixed'; overlay.style.left=0; overlay.style.top=0; overlay.style.right=0; overlay.style.bottom=0; overlay.style.zIndex=2000; overlay.style.pointerEvents='none';
            overlay.innerHTML = `<div style="position:absolute;left:50%;top:20%;transform:translateX(-50%);padding:20px 30px;border-radius:14px;background:radial-gradient(circle,#ffd54f,#ff5252);font-weight:900;color:#000;box-shadow:0 18px 60px rgba(0,0,0,0.7);">CHAIN ${type.toUpperCase()}!</div>`;
            document.body.appendChild(overlay);
            setTimeout(()=>{ overlay.style.transition='opacity 360ms ease'; overlay.style.opacity='0'; }, 900);
            setTimeout(()=>overlay.remove(), 1400);
        }

        function playSkipEffect(username) {
            // small flash and banner
            const el = document.querySelector(`#uno-opponents [data-username="${CSS.escape(username)}"]`);
            if(el) { el.classList.add('skip-flash'); setTimeout(()=>el.classList.remove('skip-flash'),900); }
            const b = document.createElement('div'); b.style.position='fixed'; b.style.left='50%'; b.style.top='18%'; b.style.transform='translateX(-50%)'; b.style.zIndex=3000; b.style.padding='12px 18px'; b.style.borderRadius='12px'; b.style.background='linear-gradient(90deg,#ff8a65,#ff5252)'; b.style.color='#fff'; b.style.fontWeight='900'; b.innerText = `SKIP!`;
            document.body.appendChild(b);
            setTimeout(()=>{ b.style.transition='opacity 400ms ease'; b.style.opacity='0'; }, 700);
            setTimeout(()=>b.remove(), 1100);
        }

        function playReverseEffect(username) {
            const el = document.querySelector(`#uno-opponents [data-username="${CSS.escape(username)}"]`);
            if(el) { el.classList.add('reverse-flip'); setTimeout(()=>el.classList.remove('reverse-flip'),1000); }
            const ring = $('color-ring'); ring.classList.add('reverse-flash'); setTimeout(()=>ring.classList.remove('reverse-flash'),1000);
            const b = document.createElement('div'); b.style.position='fixed'; b.style.left='50%'; b.style.top='15%'; b.style.transform='translateX(-50%)'; b.style.zIndex=3000; b.style.padding='14px 22px'; b.style.borderRadius='14px'; b.style.background='linear-gradient(90deg,#448aff,#7c4dff)'; b.style.color='#fff'; b.style.fontWeight='900'; b.innerText = `REVERSE!`;
            document.body.appendChild(b);
            setTimeout(()=>{ b.style.transition='opacity 400ms ease'; b.style.opacity='0'; }, 900);
            setTimeout(()=>b.remove(), 1300);
        }
        function animateCountChange(username, newCount, increase=false) {
            const el = document.querySelector(`#uno-opponents [data-username="${CSS.escape(username)}"] .opp-count`);
            if(!el) return;
            el.innerText = newCount;
            el.classList.add('count-pop');
            if(increase) el.classList.add('count-up'); else el.classList.add('count-down');
            setTimeout(()=>{ el.classList.remove('count-pop'); el.classList.remove('count-up'); el.classList.remove('count-down'); }, 600);
        }

        function flashTurn(username) {
            // highlight new turn player's opp-card briefly and pulse ring
            const el = document.querySelector(`#uno-opponents [data-username="${CSS.escape(username)}"]`);
            if(el) {
                el.classList.add('turn-flash'); setTimeout(()=>el.classList.remove('turn-flash'), 900);
            }
            const ring = $('color-ring');
            ring.classList.add('turn-flash'); setTimeout(()=>ring.classList.remove('turn-flash'), 900);
        }

        // Handle server events for actual card plays and draws
        socket.on('cardPlayed', d => {
            // animate face card from opponent area to pile
            if(d.username === myUser) return; // local plays already animated locally
            // draw-type effects
            if(d.card.type === 'draw2' || d.card.type === 'draw4') {
                if(lastPlayedDrawType === d.card.type) playChainEffect(d.card.type);
                else playDrawEffect(d.card.type);
                lastPlayedDrawType = d.card.type;
            } else {
                lastPlayedDrawType = null;
            }
            // skip/reverse special effects
            if(d.card.type === 'skip') playSkipEffect(d.username);
            if(d.card.type === 'reverse') playReverseEffect(d.username);
            animatePlayedFaceCard(d.username, d.card);
        });

        socket.on('cardDrawn', d => {
            // animate pile -> opponent (back face) when someone draws
            if(d.username === myUser) return; // local draw handled by own UI
            // play as many back-cards as drawn
            const count = Array.isArray(d.cards) ? d.cards.length : 1;
            for(let i=0;i<count;i++) setTimeout(()=> animatePileToOpponent(d.username), i*120);
        });

        function animatePlayedFaceCard(username, card) {
            const el = document.querySelector(`#uno-opponents [data-username="${CSS.escape(username)}"]`);
            const pile = $('uno-pile').querySelector('.uno-card');
            if(!el || !pile) return;
            const rect = el.getBoundingClientRect();
            const pileRect = pile.getBoundingClientRect();
            const clone = document.createElement('div');
            const cls = card.color==='black'?'u-black':`u-${card.color}`;
            clone.className = `fly-card ${cls}`;
            clone.innerHTML = `<span>${formatUnoText(card.type)}</span>`;
            clone.style.left = rect.left + 'px'; clone.style.top = rect.top + 'px';
            clone.style.width = Math.min(80, rect.width) + 'px'; clone.style.height = Math.min(120, rect.height) + 'px';
            clone.style.position = 'absolute'; clone.style.opacity = '0.98';
            document.body.appendChild(clone);
            const dx = (pileRect.left + pileRect.width/2) - (rect.left + rect.width/2);
            const dy = (pileRect.top + pileRect.height/2) - (rect.top + rect.height/2);
            requestAnimationFrame(()=>{ clone.style.transform = `translate(${dx}px, ${dy}px) scale(0.95)`; clone.style.opacity='0.0'; });
            clone.addEventListener('transitionend', ()=>{ clone.remove(); });
            setTimeout(()=>{ if(document.body.contains(clone)) clone.remove(); }, 700);
        }

        function animatePileToOpponent(username) {
            const pile = $('uno-pile').querySelector('.uno-card');
            const el = document.querySelector(`#uno-opponents [data-username="${CSS.escape(username)}"]`);
            if(!el || !pile) return;
            const pileRect = pile.getBoundingClientRect();
            const rect = el.getBoundingClientRect();
            const clone = document.createElement('div');
            clone.className = 'fly-card u-back';
            clone.style.left = pileRect.left + 'px'; clone.style.top = pileRect.top + 'px';
            clone.style.width = Math.min(80, pileRect.width) + 'px'; clone.style.height = Math.min(120, pileRect.height) + 'px';
            clone.style.position = 'absolute'; clone.style.opacity = '0.95';
            document.body.appendChild(clone);
            const dx = (rect.left + rect.width/2) - (pileRect.left + pileRect.width/2);
            const dy = (rect.top + rect.height/2) - (pileRect.top + pileRect.height/2);
            requestAnimationFrame(()=>{ clone.style.transform = `translate(${dx}px, ${dy}px) scale(0.95)`; clone.style.opacity='0.0'; });
            clone.addEventListener('transitionend', ()=>{ clone.remove(); });
            setTimeout(()=>{ if(document.body.contains(clone)) clone.remove(); }, 700);
        }

        // server announces someone called UNO
        socket.on('unoCalled', d => {
            // flashy banner for all players
            const b = document.createElement('div'); b.style.position='fixed'; b.style.left='50%'; b.style.top='10%'; b.style.transform='translateX(-50%)'; b.style.zIndex=3000; b.style.padding='14px 22px'; b.style.borderRadius='12px'; b.style.background='linear-gradient(90deg,#ffeb3b,#ff7043)'; b.style.color='#000'; b.style.fontWeight='900'; b.innerText = `${d.username} called UNO!`;
            document.body.appendChild(b);
            setTimeout(()=>{ b.style.transition='opacity 400ms ease'; b.style.opacity='0'; }, 1200);
            setTimeout(()=>b.remove(), 1700);
        });

        socket.on('unoPenalty', d => {
            const b = document.createElement('div'); b.style.position='fixed'; b.style.left='50%'; b.style.top='14%'; b.style.transform='translateX(-50%)'; b.style.zIndex=3000; b.style.padding='12px 18px'; b.style.borderRadius='10px'; b.style.background='rgba(255,0,0,0.9)'; b.style.color='#fff'; b.style.fontWeight='800'; b.innerText = `${d.username} failed to call UNO — drew 2 cards!`;
            document.body.appendChild(b);
            setTimeout(()=>{ b.style.transition='opacity 400ms ease'; b.style.opacity='0'; }, 1800);
            setTimeout(()=>b.remove(), 2300);
        });

        function toggleSelect(cardId, type, index) {
            if(!myTurn) return;
            cardId = String(cardId);
            // prevent selecting disabled cards
            const el = document.querySelector(`#uno-hand [data-id="${cardId}"]`);
            if(el && el.classList.contains('disabled')) { 
                // brief feedback
                el.classList.add('invalid-move'); setTimeout(()=>el.classList.remove('invalid-move'),300);
                return;
            }
            const pos = selectedCards.indexOf(cardId);
            if(pos !== -1) {
                selectedCards.splice(pos, 1);
                delete selectedColorChoices[cardId];
            } else {
                if(type === 'wild' || type === 'draw4') {
                    // need color choice before adding
                    pendingI = cardId;
                    $('color-picker').style.display = 'flex';
                } else {
                    selectedCards.push(cardId);
                    // visual pop animation for newly selected card
                    const el = document.querySelector(`#uno-hand [data-id="${cardId}"]`);
                    if(el) {
                        // add temporary pop to badge (will be created in refreshHandSelection)
                        setTimeout(()=>{
                            const b = el.querySelector('.select-badge');
                            if(b) { b.classList.remove('pop'); void b.offsetWidth; b.classList.add('pop'); }
                        }, 60);
                        el.classList.add('selected');
                    }
                }
            }
            refreshHandSelection();
            refreshEndTurnButton();
        }

        function refreshHandSelection() {
            // update DOM classes
            const wrappers = document.querySelectorAll('#uno-hand [data-id]');
            wrappers.forEach(el => {
                const id = String(el.getAttribute('data-id'));
                const isSel = selectedCards.includes(id);
                el.classList.toggle('selected', isSel);
                // badge update
                let badge = el.querySelector('.select-badge');
                if(isSel) {
                    if(!badge) { badge = document.createElement('div'); badge.className='select-badge'; el.appendChild(badge); }
                    badge.innerText = String(selectedCards.indexOf(id) + 1);
                    // ensure pop animation when newly created
                    if(!badge.classList.contains('pop')) {
                        badge.classList.add('pop');
                        setTimeout(()=>badge.classList.remove('pop'), 350);
                    }
                } else {
                    if(badge) badge.remove();
                }
            });
        }

        function refreshEndTurnButton() {
            const btn = document.getElementById('end-turn-btn');
            if(myTurn && selectedCards.length>0) {
                if(!btn) {
                    const b = document.createElement('button'); b.id='end-turn-btn'; b.innerText='END TURN'; b.onclick = endTurnPlay; document.getElementById('sys-msg').appendChild(b);
                }
            } else if(btn) btn.remove();
        }
        
        // Invalid Move Feedback (Optional if server rejects silently, users might be confused)
        // Here we just assume client click = send. If invalid, nothing happens (server rejects).
        // To make it robust: 
        // サーバーが弾いた場合のエラーイベントがあれば良いですが、
        // 今回は「タップ時のアニメーション」で反応したことを伝えます。
        
        function pickColor(c) { 
            $('color-picker').style.display='none';
            if(pendingI === -1) return;
            // If pendingI is an index (number) from older flow, keep backward compatibility
            if(typeof pendingI === 'number') {
                socket.emit('unoMove', {room:roomID, cardIndex:pendingI, colorChoice:c});
            } else {
                // pendingI is cardId string for selection
                const cid = String(pendingI);
                selectedColorChoices[cid] = c;
                if(!selectedCards.includes(cid)) selectedCards.push(cid);
                pendingI = -1;
                refreshHandSelection(); refreshEndTurnButton();
            }
        }

        async function endTurnPlay() {
            if(!myTurn || selectedCards.length===0) return;
            const colorChoices = selectedCards.map(id => selectedColorChoices[id] || null);
            // Disable further interaction during animation
            myTurn = false; refreshEndTurnButton();

            // animate selected cards sequentially to pile
            await animatePlaySequence(selectedCards.slice());

            // after animation, send to server
            socket.emit('unoMultiMove', { room: roomID, cardIds: selectedCards.slice(), colorChoices });
            // clear selection
            selectedCards = []; selectedColorChoices = {}; refreshHandSelection(); refreshEndTurnButton();
        }

        function animatePlaySequence(cardIdList) {
            return new Promise(async (resolve) => {
                for (let cid of cardIdList) {
                    const el = document.querySelector(`#uno-hand [data-id="${cid}"]`);
                    if (!el) { await new Promise(r => setTimeout(r, 60)); continue; }
                    await animateCardToPile(el);
                    // small delay between cards
                    await new Promise(r => setTimeout(r, 80));
                }
                resolve();
            });
        }

        function animateCardToPile(cardEl) {
            return new Promise((resolve) => {
                const rect = cardEl.getBoundingClientRect();
                const pileCard = $('uno-pile').querySelector('.uno-card');
                const pileRect = pileCard ? pileCard.getBoundingClientRect() : { left: window.innerWidth/2, top: window.innerHeight/2, width: 80, height: 120 };

                const clone = cardEl.cloneNode(true);
                clone.classList.add('fly-card');
                // match visuals
                clone.style.width = rect.width + 'px';
                clone.style.height = rect.height + 'px';
                clone.style.left = rect.left + 'px';
                clone.style.top = rect.top + 'px';
                clone.style.position = 'absolute';
                clone.style.margin = '0';
                clone.style.transform = 'translate(0,0)';
                document.body.appendChild(clone);

                // compute translation
                const dx = (pileRect.left + (pileRect.width/2)) - (rect.left + (rect.width/2));
                const dy = (pileRect.top + (pileRect.height/2)) - (rect.top + (rect.height/2));

                requestAnimationFrame(() => {
                    clone.style.transform = `translate(${dx}px, ${dy}px) scale(0.9)`;
                    clone.style.opacity = '0.9';
                });

                // when transition ends, remove clone
                const cleanup = () => { clone.removeEventListener('transitionend', cleanup); clone.remove(); resolve(); };
                clone.addEventListener('transitionend', cleanup);

                // fallback in case transitionend doesn't fire
                setTimeout(() => { if(document.body.contains(clone)) { clone.remove(); resolve(); } }, 700);
            });
        }

        // BJ (Minified)
        function renderBjLobby(ps) { $('bj-seats').innerHTML=ps.map((p,i)=>`<div style="text-align:center; min-width:80px;"><div style="color:${p.color}">${p.username}</div><div>${p.score}</div><div id="h-${i}" class="bj-cards" style="transform:scale(0.8)"></div>${p.username===myUser&&!p.ready&&p.hand.length===0?`<button onclick="socket.emit('toggleReady',{room:roomID})" style="font-size:0.8rem; padding:5px;">READY</button>`:''}<div id="act-${i}"></div></div>`).join(''); }
        function placeBet(){ socket.emit('placeBet',{room:roomID, amount:$('bet-slider').value}); $('bet-overlay').style.display='none'; }
        socket.on('bjRoundStart',d=>{ $('bet-overlay').style.display='flex'; $('d-hand').innerHTML=''; $('bj-info').innerText=`ROUND ${d.round}`; });
        socket.on('ovRoundStart',d=>{ $('bet-overlay').style.display='flex'; $('d-hand').innerHTML=''; });
        socket.on('bjUpdate',d=>upCard(d,'bj')); socket.on('ovUpdate',d=>upCard(d,'ov'));
        function upCard(d,t){
            $('bet-overlay').style.display='none';
            $('d-hand').innerHTML=(d.dealerHand||[d.dealerCard]).map(c=>mkCard(c)).join('');
            d.players.forEach((p,i)=>{
                const div=$(`h-${i}`); if(div) div.innerHTML=p.hand.map(c=>mkCard(c)).join('');
                const act=$(`act-${i}`);
                if(act && p.username===myUser && i===d.turnIndex && d.phase==='playing') {
                    if(t==='bj') act.innerHTML=`<button onclick="socket.emit('bjAction',{room:roomID,action:'hit'})">HIT</button> <button onclick="socket.emit('bjAction',{room:roomID,action:'stand'})">STAY</button>`;
                    if(t==='ov') act.innerHTML=`<button onclick="socket.emit('ovAction',{room:roomID,choice:'high'})">HI</button> <button onclick="socket.emit('ovAction',{room:roomID,choice:'low'})">LO</button>`;
                } else if(act) act.innerHTML="";
            });
        }
        function mkCard(c){ if(!c.val&&!c.power)return''; const cl=['♥','♦'].includes(c.suit)?'red':'black'; return `<div class="bj-card ${cl}">${c.rank}${c.suit}</div>`; }
        
        socket.on('gameOver', d => { alert(d.msg); location.reload(); });
    </script>
</body>
</html>