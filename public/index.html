<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NITA GAMES // PROTOCOL 21</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* --- CYBERPUNK THEME --- */
        :root {
            --bg: #050505;
            --text: #e0e0e0;
            --green: #00ff41;
            --red: #ff0055;
            --cyan: #00eaff;
            --gold: #ffd700;
            --panel: rgba(10,15,10,0.95);
        }
        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Courier New', monospace;
            margin: 0; height: 100vh; display: flex; overflow: hidden;
            background-image: linear-gradient(rgba(0,255,65,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,255,65,0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        body::after {
            content: " "; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 50; opacity: 0.5;
        }

        /* --- LAYOUT --- */
        #main-interface {
            display: flex; width: 100%; height: 100%;
            padding: 20px; gap: 20px; box-sizing: border-box; z-index: 10;
        }
        #game-area {
            flex: 3; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid #333; background: var(--panel); border-radius: 8px; position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        #chat-sidebar {
            flex: 1; display: flex; flex-direction: column; min-width: 320px;
            border: 1px solid #333; background: var(--panel); border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        /* --- LOGIN --- */
        #login-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; align-items: center; justify-content: center;
        }
        .box {
            background: #111; border: 1px solid #444; padding: 40px;
            display: flex; flex-direction: column; gap: 20px; width: 300px;
            box-shadow: 0 0 30px var(--green); border-radius: 4px;
        }
        input, button {
            background: #000; border: 1px solid #444; color: var(--text);
            padding: 15px; font-family: inherit; text-transform: uppercase; outline: none;
            font-size: 1rem;
        }
        input:focus { border-color: var(--green); box-shadow: 0 0 10px rgba(0,255,65,0.3); }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: var(--green); color: #000; box-shadow: 0 0 15px var(--green); }
        
        .btn-ready { 
            border-color: var(--gold); color: var(--gold); padding: 8px; margin-top: 5px; 
            font-size: 0.8rem; width: 100%; 
        }
        .btn-ready:hover { background: var(--gold); color: #000; }

        /* --- CHAT UI (TABS) --- */
        .chat-tabs { display: flex; border-bottom: 1px solid #444; }
        .tab-btn {
            flex: 1; padding: 12px; background: rgba(0,0,0,0.5); cursor: pointer;
            text-align: center; color: #666; font-weight: bold; border: none;
            transition: 0.2s; border-bottom: 2px solid transparent;
        }
        .tab-btn.active { color: #fff; background: rgba(0,255,65,0.05); border-bottom-color: var(--green); text-shadow: 0 0 5px var(--green); }
        
        .chat-container { flex-grow: 1; position: relative; overflow: hidden; }
        .chat-list {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding: 10px; box-sizing: border-box;
            display: none; /* Controlled by JS */
        }
        .chat-list.active { display: block; }
        
        .chat-msg { margin-bottom: 6px; word-break: break-word; font-size: 0.85rem; line-height: 1.4; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; }
        .time-tag { font-size: 0.7rem; color: #555; margin-left: 5px; float: right; }
        
        .chat-input-row { display: flex; border-top: 1px solid #444; padding: 5px; }
        #chat-input { flex-grow: 1; border: none; padding: 10px; background: transparent; }
        #chat-send { width: auto; border: none; color: var(--green); background: transparent; }

        /* --- GAME UI (BLACKJACK) --- */
        h1 { position: absolute; top: 10px; left: 20px; margin: 0; font-size: 2rem; color: #fff; text-shadow: 0 0 10px var(--green); pointer-events: none; }
        
        #bj-table { width: 90%; height: 90%; border-radius: 100px; border: 4px double #444; background: radial-gradient(circle, #0a150a, #000); position: relative; }
        .bj-dealer { position: absolute; top: 15%; width: 100%; text-align: center; }
        .bj-seats { position: absolute; bottom: 5%; width: 100%; display: flex; justify-content: space-around; align-items: flex-end; }
        .bj-seat { width: 140px; min-height: 200px; background: rgba(0,0,0,0.5); border: 1px dashed #444; padding: 10px; text-align: center; display: flex; flex-direction: column; align-items: center; position: relative; }
        .bj-seat.active { border-color: #fff; background: rgba(50,50,50,0.8); box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        
        .cards { display: flex; justify-content: center; height: 70px; margin-top: 10px; }
        .card { width: 45px; height: 65px; background: #eee; color: #000; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-left: -20px; border: 1px solid #999; animation: deal 0.3s ease-out; font-size: 1.2rem; }
        .card:first-child { margin-left: 0; }
        .card.red { color: #d00; }
        .card.back { background: #222; color: #222; border-color: #444; background-image: repeating-linear-gradient(45deg, #333 0, #333 5px, #444 5px, #444 10px); }
        @keyframes deal { from{opacity:0;transform:translateY(-50px);} to{opacity:1;transform:translateY(0);} }

        #bet-ui { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 20; border-radius: 90px; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .chip { width: 70px; height: 70px; border-radius: 50%; background: #000; border: 2px solid var(--gold); color: var(--gold); display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; margin: 10px; transition: 0.2s; }
        .chip:hover { background: var(--gold); color: #000; transform: scale(1.1); }

        #sys-msg-overlay {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            color: #fff; font-size: 1.2rem; text-shadow: 0 0 10px rgba(255,255,255,0.8);
            pointer-events: none; z-index: 30; text-align: center;
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-overlay">
        <div class="box">
            <h2 style="text-align:center; margin:0; color:#888;">NITA GAMES<br><span style="font-size:0.7em; color:var(--green);">PROTOCOL 21</span></h2>
            <input type="text" id="username" placeholder="CODENAME" maxlength="10">
            <input type="text" id="room" placeholder="ROOM ID">
            <button onclick="joinGame()">INITIALIZE SYSTEM</button>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="main-interface" style="display:none;">
        <h1>PROTOCOL 21</h1>

        <!-- GAME AREA -->
        <div id="game-area">
            <div id="bj-table">
                <div style="position:absolute; top:20px; left:30px; color:var(--green); font-size:1.2rem;" id="bj-info">ROUND: 1/7</div>
                
                <div id="bet-ui">
                    <h2 style="color:#fff;">PLACE WAGER</h2>
                    <div style="display:flex;">
                        <div class="chip" onclick="bet(2)">2</div>
                        <div class="chip" onclick="bet(5)">5</div>
                        <div class="chip" onclick="bet(10)">10</div>
                    </div>
                </div>

                <div class="bj-dealer">
                    <div style="font-size:0.8rem; color:#888;">DEALER</div>
                    <div class="cards" id="d-cards"></div>
                </div>
                <div class="bj-seats" id="bj-seats"></div>
            </div>
            <div id="sys-msg-overlay"></div>
        </div>

        <!-- CHAT SIDEBAR -->
        <div id="chat-sidebar">
            <div class="chat-tabs">
                <button class="tab-btn active" onclick="switchTab('global')" id="tab-global">GLOBAL</button>
                <button class="tab-btn" onclick="switchTab('room')" id="tab-room">ROOM</button>
            </div>
            <div class="chat-container">
                <div id="list-global" class="chat-list active">
                    <div style="color:#666; text-align:center; margin-top:10px;">// GLOBAL FREQUENCY CONNECTED</div>
                </div>
                <div id="list-room" class="chat-list">
                    <div style="color:#666; text-align:center; margin-top:10px;">// ROOM COMMS SECURE</div>
                </div>
            </div>
            <div class="chat-input-row">
                <input type="text" id="chat-input" placeholder="TRANSMIT..." onkeydown="if(event.key==='Enter')sendChat()">
                <button id="chat-send" onclick="sendChat()">TX</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let roomID = '', myUser = '', myColor = '';
        let currentTab = 'global'; // 'global' or 'room'

        // --- TIME HELPER ---
        function getRelativeTime(timestamp) {
            const now = Date.now();
            const diff = Math.floor((now - timestamp) / 1000); // seconds
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            return `${Math.floor(diff / 3600)}h ago`;
        }

        // --- CHAT SYSTEM ---
        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-global').className = tab === 'global' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tab-room').className = tab === 'room' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('list-global').className = tab === 'global' ? 'chat-list active' : 'chat-list';
            document.getElementById('list-room').className = tab === 'room' ? 'chat-list active' : 'chat-list';
            
            // Auto scroll to bottom when switching
            const list = document.getElementById(`list-${tab}`);
            list.scrollTop = list.scrollHeight;
        }

        function sendChat() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();
            if (!txt) return;

            // Room chat blocked if not joined
            if (currentTab === 'room' && !roomID) {
                alert("JOIN A ROOM FIRST");
                return;
            }

            // If global, use temp username if not logged in
            const senderName = myUser || document.getElementById('username').value || 'ANONYMOUS';

            socket.emit('sendChat', {
                type: currentTab,
                room: roomID,
                username: senderName,
                text: txt,
                color: myColor
            });
            inp.value = '';
        }

        function renderMsg(msg) {
            const targetList = document.getElementById(`list-${msg.type}`);
            const div = document.createElement('div');
            div.className = 'chat-msg';
            
            const timeStr = getRelativeTime(msg.timestamp);
            const userColor = msg.color === 'black' ? '#aaa' : (msg.color === 'white' ? '#fff' : msg.color);
            
            div.innerHTML = `
                <span class="time-tag">${timeStr}</span>
                <span style="color:${userColor}; font-weight:bold;">[${msg.username}]</span>
                <span style="color:#ddd;">${msg.text}</span>
            `;
            targetList.appendChild(div);
            targetList.scrollTop = targetList.scrollHeight;
        }

        socket.on('chatMsg', msg => renderMsg(msg));
        
        socket.on('chatHistory', ({ type, logs }) => {
            const targetList = document.getElementById(`list-${type}`);
            // Clear existing except header
            targetList.innerHTML = `<div style="color:#666; text-align:center; margin-top:10px;">// ${type.toUpperCase()} HISTORY SYNCED</div>`;
            logs.forEach(log => renderMsg(log));
        });

        // --- GAME JOIN ---
        function joinGame() {
            myUser = document.getElementById('username').value || 'ANONYMOUS';
            roomID = document.getElementById('room').value;
            if(!roomID) return alert("ROOM ID REQUIRED");
            socket.emit('joinRoom', { username: myUser, room: roomID });
        }

        socket.on('joined', d => {
            myColor = d.color;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-interface').style.display = 'flex';
            // Auto switch to room tab
            switchTab('room');
        });

        socket.on('roomUpdate', d => {
            document.getElementById('bj-info').innerText = `ROUND: -/${d.maxRounds}`;
            renderBjSeats(d.players);
        });

        // --- BJ UI ---
        function renderBjSeats(players) {
            const c = document.getElementById('bj-seats'); c.innerHTML = '';
            players.forEach((p, i) => {
                const div = document.createElement('div'); div.className = 'bj-seat'; div.id = `seat-${i}`;
                div.innerHTML = `
                    <div style="color:${p.color}; font-weight:bold;">${p.username}</div>
                    <div style="color:var(--gold); font-weight:bold;">${p.score} PTS</div>
                    <div style="color:#fff; font-size:0.8rem; margin-top:5px;" id="stat-${i}">${p.ready?'READY':''}</div>
                    <div class="cards" id="hand-${i}"></div>
                    <div id="ctrl-${i}" style="margin-top:auto; width:100%;"></div>
                `;
                c.appendChild(div);
                if(p.hand) { const h = div.querySelector('.cards'); p.hand.forEach(cd=>h.appendChild(mkCard(cd))); }
                
                // READY Button
                if(p.id === socket.id && !p.ready && p.hand.length === 0) {
                    const btn = document.createElement('button'); btn.className = "btn-ready"; btn.innerText = "READY";
                    btn.onclick = () => socket.emit('bjToggleReady', {room:roomID});
                    div.querySelector(`#ctrl-${i}`).appendChild(btn);
                }
            });
        }
        function mkCard(c) {
            const el = document.createElement('div'); el.className = `card ${['♥','♦'].includes(c.suit)?'red':''}`;
            if(c.suit==='?') el.className += ' back'; else el.innerText = c.rank + c.suit;
            return el;
        }
        function bet(a) { socket.emit('bjBet', {room:roomID, amount:a}); document.getElementById('bet-ui').style.display='none'; }

        socket.on('bjRoundStart', d => {
            document.getElementById('bj-info').innerText = `ROUND: ${d.round}/${d.maxRounds}`;
            document.getElementById('bet-ui').style.display = 'flex';
            document.getElementById('d-cards').innerHTML = '';
        });
        
        socket.on('bjUpdate', d => {
            document.getElementById('bet-ui').style.display = 'none';
            const dc = document.getElementById('d-cards'); dc.innerHTML = ''; d.dealerHand.forEach(c=>dc.appendChild(mkCard(c)));
            d.players.forEach((p,i) => {
                const h = document.getElementById(`hand-${i}`); if(h){ h.innerHTML=''; p.hand.forEach(c=>h.appendChild(mkCard(c))); }
                const st = document.getElementById(`stat-${i}`); if(st) st.innerText = p.status==='playing'?'':p.status;
                const s = document.getElementById(`seat-${i}`); if(s) {
                    if(i===d.turnIndex && d.phase==='playing') s.classList.add('active'); else s.classList.remove('active');
                    const ctrl = document.getElementById(`ctrl-${i}`); ctrl.innerHTML='';
                    if(p.id===socket.id && i===d.turnIndex && d.phase==='playing') {
                        ctrl.innerHTML = `<button class="btn-ready" onclick="socket.emit('bjAction',{room:roomID,action:'hit'})">HIT</button> <button class="btn-ready" onclick="socket.emit('bjAction',{room:roomID,action:'stand'})">STAND</button>`;
                    }
                }
            });
        });

        socket.on('bjRoundOver', d => {
             const dc = document.getElementById('d-cards'); dc.innerHTML = ''; d.dealerHand.forEach(c=>dc.appendChild(mkCard(c)));
             d.players.forEach((p,i) => {
                 const st = document.getElementById(`stat-${i}`); if(st) { st.innerText = p.result; st.style.color = p.result.includes('WIN')?'#0f0':'#f00'; }
                 const s = document.getElementById(`seat-${i}`); if(s) s.children[1].innerText = `${p.score} PTS`;
             });
             document.getElementById('sys-msg-overlay').innerText = d.isMatchOver ? "MATCH COMPLETE" : "ROUND END";
        });
        
        socket.on('gameOver', d => { 
            alert(d.msg); 
            // ページリロードせず、初期状態に戻す処理が理想だが、簡易的にリロード
            location.reload(); 
        });
        socket.on('forceReset', () => location.reload());
        socket.on('error', m => alert(m));

    </script>
</body>
</html>